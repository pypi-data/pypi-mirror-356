<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>{{ 'APP_NAME' | appconfig }}: Users</title>
    <link rel="icon" type="image/x-icon" href="
        {% if not 'APP_FAVICON' | appconfig %}
        {{ url_for('edits.static', filename='favicon.ico') }}
        {% else %}
        {{ 'APP_FAVICON' | appconfig | safe }}
        {% endif %}" />
    <link href="{{ url_for('edits.static', filename='bootstrap/css/bootstrap.min.css')}}" rel="stylesheet" />
    <link href="{{ url_for('edits.static', filename='bootstrap/css/navbar.css')}}" rel="stylesheet" />
    <link href="{{ url_for('edits.static', filename='bootstrap-switch/css/bootstrap-switch.min.css') }}" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
      .btn-logout {
        background-color: red;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        margin-left: 15px;
      }
    
      .btn-logout:hover {
        background-color: rgb(226, 26, 26); 
        color: #eee;/* Darker red on hover */
      }

      .checkbox-container {
        display: flex;
        flex-wrap: wrap;
      }

      .checkbox-container .checkbox {
        flex: 1 1 30%;
        margin-top: 5px;
        margin-bottom: 5px;
      }

      .form-group .caution {
        color: red;
        font-size: 12px;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
      }

      .navbar-nav {
        display: flex;
        align-items: center;
      }

      .navbar-nav a {
        font-size: 15px;
        padding: 10px;
        margin-top: 6px;
        margin-left: 15px;
        color: #252525;
        text-decoration: none;
      }
      .navbar-nav a:hover {
        color: #000000;
        transform: scale(1.05);
      }
      .navbar-nav .active {
        border-radius: 10px;
        background-color: rgb(217, 217, 217);
        
      }
    </style>
    
  </head>
  {% if ERROR %}
  <script>
    window.onload = function() {
        document.getElementById("addUser").click();
        var username = "{{ user[0] }}";
        var password = "{{ user[1] }}";
        var passwordRetryAttempts = "{{ user[2] }}";
        var passwordRetryTime = "{{ user[3] }}";
        var roles = "{{ user[4] }}";
        var modal = $('#addUserModal');
        modal.find('.modal-body #addUsername').val(username);
        modal.find('.modal-body #addPassword').val(password);
        modal.find('.modal-body #addPasswordRetryAttempts').val(passwordRetryAttempts);
        modal.find('.modal-body #addPasswordRetryTime').val(passwordRetryTime);
        modal.find('.modal-body #addRoles').val(roles);
        modal.find('.modal-body .alert').remove();
        modal.find('.modal-body').prepend('<div class="alert alert-danger">{{ ERROR }}</div>');
        updateCheckboxes(String(roles), modal);
    };
  </script>
  {% endif %}
  <body>
    <div class="container">
      {{ value | editsnavbar | safe }}
      <div class="row">
        <div class="col-sm-12">
                <p class="lead mb-0">Users<button class="btn btn-success btn-sm pull-right" data-toggle="modal" data-target="#addUserModal" id="addUser" >Add User</button></p>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th style="width: 25px;">#</th>
                  <th style="width: 10vw">Username</th>
                  <th>Roles</th>
                  <th style="width: 120px;">Password Retry Attempts</th>
                  <th style="width: 120px;">Password Retry Time</th>
                  <th style="width: 120px;">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                <tr>
                  <td>{{ user.id }}</td>
                  <td>{{ user.username }}</td>
                  <td>
                    {% set role = user.roles | fromjsonremoveprefix %}
                    {% if role == "/" %}
                    Owner (All)
                    {% else %}
                    {{ role }}
                    {% endif %}
                  </td>
                  <td>{{ user.password_retry_attemts }}</td>
                  <td>{{ user.password_retry_time }} sec</td>
                  <td>
                    {% set default_username = 'EDITS_USERNAME' | appconfig %}
                    <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#editUserModal" data-username="{{ user.username }}" data-roles="{{ user.roles }}" data-password-retry-attemts="{{ user.password_retry_attemts }}" data-password-retry-time="{{ user.password_retry_time }}" {% if user.username == default_username %}disabled{% endif %}>Edit</button>
                    <button class="btn btn-danger btn-sm" data-toggle="modal" data-target="#deleteUserModal" data-username="{{ user.username }}" {% if user.username == default_username %}disabled{% endif %}>Delete</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <!-- Edit User Modal -->
      <div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title" id="editUserModalLabel">Edit User</h4>
            </div>
            <div class="modal-body">
              <form id="editUserForm" action="{{ url_for('edits.users', action='edit') }}" method="post">
                <div class="form-group">
                  <label for="editUsername">Username</label>
                  <input type="text" class="form-control" id="editUsername" name="username" required>
                </div>
                <div class="form-group">
                  <label for="editPassword">Password</label>
                  <input type="password" class="form-control" id="editPassword" name="password">
                  <p class="caution">Caution: If changed user won't be able to login with the previous password.</p>
                </div>
                <div class="form-group">
                  <label for="editPasswordRetryAttempts">Password Retry Attempts</label>
                  <input type="number" class="form-control" id="editPasswordRetryAttempts" name="password_retry_attemts" required>
                </div>
                <div class="form-group">
                  <label for="editPasswordRetryTime">Password Retry Time</label>
                  <input type="number" class="form-control" id="editPasswordRetryTime" name="password_retry_time" required>
                </div>
                <div class="form-group">
                  <label for="editRoles">Roles</label>
                  <input type="text" class="form-control" id="editRoles" name="roles" required readonly>
                  <div class="checkbox-container">
                    {% set edits = value | retrive_edits %}
                    {% if edits|length %}
                    {% for page, regions in edits.items() %}
                      <div class="checkbox">
                        <label>
                          <input type="checkbox" class="role-checkbox" value="{{ page }}">{{ page }}
                        </label>
                      </div>
                    {% endfor %}
                    {% endif %}
                  </div>
                  {% if 'ENABLE_ANALYTICS' | appconfig or 'EDITS_LOCKED' | appconfig == "SQL" or 'ENABLE_RESOURCE_MONITER' | appconfig or 'ENABLE_STATIC' | appconfig %}
                  <div class="checkbox-container">
                    {% if 'ENABLE_ANALYTICS' | appconfig %}
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" class="role-checkbox" value="analytics"> Analytics
                      </label>
                    </div>
                    {% endif %}
                    {% if 'EDITS_LOCKED' | appconfig == "SQL" %}
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" class="role-checkbox" value="users"> Users
                      </label>
                    </div>
                    {% endif %}
                    {% if 'ENABLE_RESOURCE_MONITER' | appconfig %}
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" class="role-checkbox" value="monitor"> Resources
                      </label>
                    </div>
                    {% endif %}
                    {% if 'ENABLE_STATIC' | appconfig %}
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" class="role-checkbox" value="{{ 'APP_STATIC_FOLDER' | appconfig }}"> View: {{ 'APP_STATIC_FOLDER' | appconfig }}
                      </label>
                    </div>
                    {% endif %}
                    {% if 'EDITABLE_STATIC' | appconfig %}
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" class="role-checkbox" value="{{ 'APP_STATIC_FOLDER' | appconfig }}-view"> Edit: {{ 'APP_STATIC_FOLDER' | appconfig }}
                      </label>
                    </div>
                    {% endif %}
                  </div>
                  {% endif %}
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
            <!-- Add User Modal -->
      <div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title" id="addUserModalLabel">Add User</h4>
            </div>
            <div class="modal-body">
              <form id="addUserForm" action="{{ url_for('edits.users', action='add') }}" method="post">
                <div class="form-group">
                  <label for="addUsername">Username</label>
                  <input type="text" class="form-control" id="addUsername" name="username" required>
                </div>
                <div class="form-group">
                  <label for="addPassword">Password</label>
                  <input type="password" class="form-control" id="addPassword" name="password" required>
                </div>
                <div class="form-group">
                  <label for="addPasswordRetryAttempts">Password Retry Attempts</label>
                  <input type="number" class="form-control" id="addPasswordRetryAttempts" name="password_retry_attemts" required>
                </div>
                <div class="form-group">
                  <label for="addPasswordRetryTime">Password Retry Time</label>
                  <input type="number" class="form-control" id="addPasswordRetryTime" name="password_retry_time" required>
                </div>
                <div class="form-group">
                  <label for="addRoles">Roles</label>
                  <input type="text" class="form-control" id="addRoles" name="roles" required readonly>
                  <div class="checkbox-container">
                    {% if edits|length %}
                    {% for page, regions in edits.items() %}
                      <div class="checkbox">
                        <label>
                          <input type="checkbox" class="role-checkbox" value="{{ page }}"> {{ page }}
                        </label>
                      </div>
                    {% endfor %}
                    {% endif %}
                    {% if 'ENABLE_ANALYTICS' | appconfig or 'EDITS_LOCKED' | appconfig == "SQL" or 'ENABLE_RESOURCE_MONITER' | appconfig or 'ENABLE_STATIC' | appconfig %}
                  <div class="checkbox-container">
                    {% if 'ENABLE_ANALYTICS' | appconfig %}
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" class="role-checkbox" value="analytics"> Analytics
                      </label>
                    </div>
                    {% endif %}
                    {% if 'EDITS_LOCKED' | appconfig == "SQL" %}
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" class="role-checkbox" value="users"> Users
                      </label>
                    </div>
                    {% endif %}
                    {% if 'ENABLE_RESOURCE_MONITER' | appconfig %}
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" class="role-checkbox" value="monitor"> Resources
                      </label>
                    </div>
                    {% endif %}
                    {% if 'ENABLE_STATIC' | appconfig %}
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" class="role-checkbox" value="{{ 'APP_STATIC_FOLDER' | appconfig }}"> View: {{ 'APP_STATIC_FOLDER' | appconfig }}
                      </label>
                    </div>
                    {% endif %}
                    {% if 'EDITABLE_STATIC' | appconfig %}
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" class="role-checkbox" value="{{ 'APP_STATIC_FOLDER' | appconfig }}-view"> Edit: {{ 'APP_STATIC_FOLDER' | appconfig }}
                      </label>
                    </div>
                    {% endif %}
                  </div>
                  {% endif %}
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">Add User</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
            <!-- Delete User Modal -->
      <div class="modal fade" id="deleteUserModal" tabindex="-1" role="dialog" aria-labelledby="deleteUserModalLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title" id="deleteUserModalLabel">Delete User</h4>
            </div>
            <div class="modal-body">
              <p>Are you sure you want to delete this user?</p>
              <form id="deleteUserForm" action="{{ url_for('edits.users', action='delete') }}" method="post">
                <input type="hidden" id="deleteUsername" name="username">
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-danger">Delete</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
        </div>
      </div>
    </div>
  </body>

  <script type="text/javascript" src="//code.jquery.com/jquery-1.9.1.min.js"></script> 
  <script type="text/javascript" src="{{ url_for('edits.static', filename='bootstrap/js/bootstrap.min.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('edits.static', filename='bootstrap-switch/js/bootstrap-switch.min.js') }}"></script>
  <script>
    $(document).ready(function() {
      $('[name="mode"]').bootstrapSwitch({
        onText: 'On',
        offText: 'Off',
        onSwitchChange: function(e, state) {
          $.post("{{ url_for('edits.preview') }}", {state: state});
        }
      });

      $('#editUserModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var username = button.data('username');
        var roles = button.data('roles');
        var passwordRetryAttempts = button.data('password-retry-attemts');
        var passwordRetryTime = button.data('password-retry-time');
        var modal = $(this);
        modal.find('.modal-body #editUsername').val(username);
        modal.find('.modal-body #editRoles').val(roles);
        modal.find('.modal-body #editPasswordRetryAttempts').val(passwordRetryAttempts);
        modal.find('.modal-body #editPasswordRetryTime').val(passwordRetryTime);
        updateCheckboxes(String(roles), modal);
      });

      $('#editUserForm').on('submit', function(event) {
        event.preventDefault();
        var formData = $(this).serialize();
        $.post("{{ url_for('edits.users', action='edit') }}", formData, function(response) {
          location.reload();
        });
      });

      $('#addUserForm').on('submit', function(event) {
        event.preventDefault();
        var formData = $(this).serialize();
        $.post("{{ url_for('edits.users', action='add') }}", formData, function(response) {
          location.reload();
        });
      });

      $('#deleteUserModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var username = button.data('username');
        var modal = $(this);
        modal.find('.modal-body #deleteUsername').val(username);
      });

      $('#deleteUserForm').on('submit', function(event) {
        event.preventDefault();
        var formData = $(this).serialize();
        $.post("{{ url_for('edits.users', action='delete') }}", formData, function(response) {
          location.reload();
        });
      });

      $('.role-checkbox').on('change', function() {
        var roles = [];
        $('.role-checkbox:checked').each(function() {
          roles.push($(this).val());
        });
        $(this).closest('.modal-body').find('input[name="roles"]').val(roles.join(','));
      });

      function updateCheckboxes(roles, modal) {
        var rolesArray = roles.split(',');
        modal.find('.role-checkbox').each(function() {
          if (rolesArray.includes($(this).val())) {
            $(this).prop('checked', true);
          } else {
            $(this).prop('checked', false);
          }
        });
      }
    });

    function deleteUser(username) {
      $('#deleteUserModal').modal('show');
      $('#deleteUserModal').find('.modal-body #deleteUsername').val(username);
    }
  </script>
</html>