import{j as V,r as _,n as x,q as B,w as r,A as U,o as A,a as v,b as g,s as c,z as E,d as l,B as T,m as I,k as p,C as q}from"./DenydyMN.js";import{r as N}from"./hPHynIdq.js";import{i as P}from"./0wQYiv8f.js";import{h,r as k}from"./Ch47lW9D.js";import"./Ch7Mx1Yh.js";const j={style:{"max-width":"30rem"}},L={class:"margin-button centered-container"},K=V({__name:"login-page",setup($){const w=I(),a=_(""),i=_(""),n=_({username:!1,password:!1});async function R(){n.value=N(n.value);let d=!1;if(a.value.trim()===""&&(n.value.username=!0,d=!0),i.value.trim()===""&&(n.value.password=!0,d=!0),d){P();return}const t={grant_type:"password",username:a.value,password:i.value},m=[];for(const o in t){const e=encodeURIComponent(o),u=encodeURIComponent(t[o]);m.push(e+"="+u)}const f=m.join("&");let s=0;try{await $fetch(w.public.apiPath+"/token",{retry:0,method:"POST",headers:{accept:"application/json","Content-Type":"application/x-www-form-urlencoded"},body:f,onRequestError(){k()},onResponse({response:e}){var u,y;if(e.ok){s=(u=e==null?void 0:e._data)==null?void 0:u.expires_in;const b=p("token",{maxAge:s}),C=p("user",{maxAge:s});b.value=(y=e==null?void 0:e._data)==null?void 0:y.access_token,C.value=a.value}},onResponseError({response:e}){h(e.status,e._data.error_description)}});const o=p("token");await $fetch(w.public.apiPath+"/user/me",{retry:0,method:"GET",headers:{Authorization:"Bearer "+o.value},onRequestError(){k()},onResponse({response:e}){if(e.ok){const u=p("userRole",{maxAge:s});u.value=e._data.role}},onResponseError({response:e}){h(e.status,e._data.error_description)}}),q("/")}catch(o){console.log("Error in login: "),console.log(o)}}return(d,t)=>{const m=x("UsaTextInput"),f=x("UsaButton"),s=U;return A(),B(s,{name:"base-layout"},{"page-title":r(()=>[l("Login")]),default:r(()=>[v("form",null,[v("div",j,[g(m,{modelValue:c(a),"onUpdate:modelValue":t[0]||(t[0]=o=>E(a)?a.value=o:null),error:c(n).username},{label:r(()=>[l(" Username ")]),"error-message":r(()=>[l(" Enter a username ")]),_:1},8,["modelValue","error"]),g(m,{modelValue:c(i),"onUpdate:modelValue":t[1]||(t[1]=o=>E(i)?i.value=o:null),error:c(n).password,type:"password"},{label:r(()=>[l(" Password ")]),"error-message":r(()=>[l(" Enter a password ")]),_:1},8,["modelValue","error"]),v("div",L,[g(f,{type:"submit",class:"primary-button",onClick:t[2]||(t[2]=T(o=>R(),["prevent"]))},{default:r(()=>[l(" Login ")]),_:1})])])])]),_:1})}}});export{K as default};
