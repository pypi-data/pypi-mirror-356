# `icon_masker.py`

## 1. Guide

1. `icon-perfect.png` is the reference 1200x1200 PNG image which we want to match. We need to match the edge and corners. We also have 4 quarters:  `icon-perfect-00.png` (top left), `icon-perfect-10.png` (top right), `icon-perfect-01.png` (bottom left), `icon-perfect-11.png` (bottom right). 

2. `best_base.svg` is the vector form of the icon, with the 1024x1024px bounding box centered inside 1200x1200px canvas. This is the "base" version that we process using `icon_blender.py` to produce `best_full.svg`. 

3. To convert the "base" version into the "full" version: 

```
python icon_blender.py --input_svg best_base.svg --output_svg best_full.svg --steps 24
``` 

4. To rasterize `best_full.svg` into PNG: 

```
rsvg-convert -o best_full.pdf -f pdf best_full.svg;sips -s format png --resampleWidth 1200 best_full.pdf --out best_full.png;
``` 

5. To split a PNG into 4 quarters: 

```
./imgquart.py best_full.png
```

This produces: `best_full-00.png` (top left), `best_full-10.png` (top right), `best_full-01.png` (bottom left), `best_full-11.png` (bottom right). This way you can examine the quarters closer. 

6. To add a payload to the SVG: 

```
python ./icon_masker.py --payload payload.svg --outdir .
```


## 2. Task formulation

It’s all good and nice that we have a grayscale "icon" (`best_full.svg` made from `best_base.svg` using the `icon_blender.py` tool). 

But actually, we want this to be a kind of vector mask, in two modes, "light" or "dark". 

I want to take an input vector graphic, and then somehow "apply" the mask to it, and the center area is replaced with the graphic, cropped by the rounded square, and the edge highlight colorization is preserved but in form of semi transparent "glass" (light or dark). 

Look at the images like `best_full.png` to understand. Then write a detailed specification into `SPEC.md`. Describe the process exactly. 

## 3. Task solution

• Added `icon_masker.py` – a one-shot builder that:
  1. Calls `icon_blender.py` to generate 24 bevel steps.  
  2. Injects clipPath, payload slot, theme groups, and light/dark gradient copies.  
  3. Exports `mask-light.svg` and `mask-dark.svg` (payload optional).

• Fixed edge-rendering bug: kept original decorative layers visible and preserved `gradient1/2/3` IDs; dark variants are duplicated as `*-dark`.

• Verified by building to `output2/` – bevel + corner glint now render correctly, payload is clipped, and dark mode flips via gradient IDs.

## 4. Purpose

Provide a deterministic, automatable pipeline that converts the _base_ SVG icon (a double-rounded square frame) into an embeddable **vector mask**. The mask can then be combined with an arbitrary foreground graphic so that:

1. The foreground graphic is clipped to the inner rounded-square (“window”).
2. A multi-step bevel around that window provides a subtle 3-D “liquid-glass” edge.
3. The entire composition supports two visual themes – **light** and **dark** – selected by _one_ CSS class / attribute toggle.

The spec covers file structure, colour tokens, SVG element IDs, generation commands, and expected output.

## 5. Glossary

| Term | Meaning |
| --- | --- |
| **base SVG** | `best_base.svg` – the canonical editable source, contains only 3 paths (outer, small highlight, inner) plus gradient definitions |
| **full SVG** | Derived SVG with additional _N_ intermediary paths forming the bevel (generated by `icon_blender.py`) |
| **mask SVG** | Final theme-aware SVG which exposes a `<clipPath>` for user artwork and contains a light & dark `<g>` each holding the bevel + highlight layers |
| **payload** | The foreign (user) artwork to appear inside the mask window |

## 6. Directory / file layout

```text
./
├─ best_base.svg         # committed source
├─ icon_masker.py
├─ output/
│   ├─ mask-light.svg
│   └─ mask-dark.svg
└─ payload.svg           # sample artwork used for testing
```

> The _scripts_ directory is optional – colour tokens may instead live inside the SVG under a `<style>` block. The build script decides.

## 7. Step-by-step generation

### 7.1. Produce bevel-enriched "full" SVG

```bash
python icon_blender.py \
  --input_svg best_base.svg \
  --output_svg tmp_full.svg \
  --steps 24 \
  --gradient_id gradient3 \
  --opacity_start 0.88 \
  --opacity_end   0.05
```

_Rationale_: 24 steps deliver a smooth 1-pixel fall-off when rasterised to 1200 px.

### 7.2. Extract canonical IDs

The script guarantees these **IDs** exist and must remain unchanged downstream:

| Layer                   | id attribute |
| ----------------------- | ------------ |
| outer frame             | `outer`      |
| inner frame             | `inner`      |
| quarter-glint highlight | `small`      |
| bevel group             | `bevelSteps` |

### 7.3. Insert clipPath & payload slot

Immediately **after** the `<defs>` section append:

```xml
<!-- mask window for user payload -->
<clipPath id="innerClip">
  <use href="#inner"/>
</clipPath>

<!-- slot: user artwork goes here -->
<g id="payload" clip-path="url(#innerClip)"></g>
```

### 7.4. Theme separation

Wrap the decorative layers in two sibling groups so that a single class hides/shows them:

```xml
<g id="theme-light" class="theme-light">
  <use href="#outer"    fill="url(#gradient1-light)"/>
  <use href="#bevelSteps"/>
  <use href="#small"    fill="url(#gradient2-light)"/>
</g>
<g id="theme-dark"  class="theme-dark">
  <use href="#outer"    fill="url(#gradient1-dark)"/>
  <use href="#bevelSteps"/>
  <use href="#small"    fill="url(#gradient2-dark)"/>
</g>
```

A tiny CSS snippet toggles visibility:

```css
.theme-light {
  display: none;
}
.theme-dark {
  display: none;
}
:root[data-theme='light'] .theme-light {
  display: inline;
}
:root[data-theme='dark'] .theme-dark {
  display: inline;
}
```

### 7.5. Provide colour tokens

Define six gradients (light/dark × 3):

```xml
<defs>
  <!-- outer rim radial gradient -->
  <radialGradient id="gradient1-light"  ... />
  <radialGradient id="gradient1-dark"   ... />
  <!-- inner face linear gradient (re-used by bevel) -->
  <linearGradient  id="gradient3-light" ... />
  <linearGradient  id="gradient3-dark"  ... />
  <!-- corner glint -->
  <radialGradient id="gradient2-light"  ... />
  <radialGradient id="gradient2-dark"   ... />
</defs>
```

`bevelSteps` maintain their `fill="url(#gradient3-light|dark)"` via a simple search-replace.

### 7.6. Final minification & validation

- `svgo --config svgo.config.mjs -i mask.svg -o output/mask-light.svg`
- Duplicate and replace `gradient*-light → gradient*-dark`, `theme-light → theme-dark` to obtain the dark variant if exporting two physical files.
- Validate raster output: `rsvg-convert output/mask-light.svg -o test.png && open test.png`.

## 8. Embedding / Runtime API

```html
<!-- host document -->
<object data="mask-light.svg" type="image/svg+xml" id="logo"></object>
<script>
  const logo = document.getElementById('logo');
  logo.addEventListener('load', () => {
    const svg = logo.contentDocument;
    const slot = svg.getElementById('payload');
    // inject user artwork e.g. via <image> or cloned paths
    slot.appendChild(svg.importNode(document.getElementById('myArt'), true));
    // toggle theme
    svg.documentElement.dataset.theme = matchMedia(
      '(prefers-color-scheme: dark)'
    ).matches
      ? 'dark'
      : 'light';
  });
</script>
```

## 9. Quality-Assurance checklist

- [ ] Generated bevel count = 24, `bevelSteps` present
- [ ] Exactly 6 gradients (light/dark × 3) with correct IDs
- [ ] `<clipPath id="innerClip">` matches `#inner` geometry _pixel-perfect_
- [ ] No stray `fill="#666"` or hard-coded colours – everything via gradients
- [ ] File passes `svglint`, no missing `xmlns` or broken `href`
- [ ] Light & dark render within ΔE < 2 of reference raster screenshots
- [ ] `payload` group present and empty in artifact

## 10. Build automation (reference Python script)

The provided `icon_masker.py` automates every step described above. Run:

```bash
python ./icon_masker.py --payload payload.svg --outdir output4
```

It produces:

1. `output/mask-light.svg` – default light-theme mask with payload injected
2. `output/mask-dark.svg` – identically-structured dark variant

Both files embed the live payload group so you can swap the artwork later via DOM manipulation.

## 11. Future extensions

- Support a third **glass-frosted** theme with blurred background using SVG filters.
- Publish to NPM as `@liquid-glass/icon-mask` for straightforward web bundling.

---

_End of specification._
