"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[2877],{12877:(e,t,n)=>{n.r(t),n.d(t,{default:()=>I,getLayer:()=>N,getPoints:()=>$});var i=n(96540),o=n(78518),l=n(84402),a=n(18277),r=n(81729),s=n(82077),u=n(91018),c=n(98595),d=n(93559);const g=[0,0,0,255],h={stroked:!0,filled:!0,extruded:!1,elevationScale:1,wireframe:!1,_normalize:!0,_windingOrder:"CW",lineWidthUnits:"meters",lineWidthScale:1,lineWidthMinPixels:0,lineWidthMaxPixels:Number.MAX_SAFE_INTEGER,lineJointRounded:!1,lineMiterLimit:4,getPolygon:{type:"accessor",value:e=>e.polygon},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:g},getLineWidth:{type:"accessor",value:1},getElevation:{type:"accessor",value:1e3},material:!0};class p extends l.A{initializeState(){this.state={paths:[],pathsDiff:null},this.props.getLineDashArray&&a.A.removed("getLineDashArray","PathStyleExtension")()}updateState({changeFlags:e}){const t=e.dataChanged||e.updateTriggersChanged&&(e.updateTriggersChanged.all||e.updateTriggersChanged.getPolygon);if(t&&Array.isArray(e.dataChanged)){const t=this.state.paths.slice(),n=e.dataChanged.map((e=>(0,d.J)({data:t,getIndex:e=>e.__source.index,dataRange:e,replace:this._getPaths(e)})));this.setState({paths:t,pathsDiff:n})}else t&&this.setState({paths:this._getPaths(),pathsDiff:null})}_getPaths(e={}){const{data:t,getPolygon:n,positionFormat:i,_normalize:o}=this.props,l=[],a="XY"===i?2:3,{startRow:s,endRow:u}=e,{iterable:d,objectInfo:g}=(0,r.X)(t,s,u);for(const e of d){g.index++;let t=n(e,g);o&&(t=c.S8(t,a));const{holeIndices:i}=t,r=t.positions||t;if(i)for(let t=0;t<=i.length;t++){const n=r.slice(i[t-1]||0,i[t]||r.length);l.push(this.getSubLayerRow({path:n},e,g.index))}else l.push(this.getSubLayerRow({path:r},e,g.index))}return l}renderLayers(){const{data:e,_dataDiff:t,stroked:n,filled:i,extruded:o,wireframe:l,_normalize:a,_windingOrder:r,elevationScale:c,transitions:d,positionFormat:h}=this.props,{lineWidthUnits:p,lineWidthScale:f,lineWidthMinPixels:m,lineWidthMaxPixels:y,lineJointRounded:_,lineMiterLimit:b,lineDashJustified:v}=this.props,{getFillColor:A,getLineColor:C,getLineWidth:L,getLineDashArray:x,getElevation:w,getPolygon:S,updateTriggers:k,material:F}=this.props,{paths:P,pathsDiff:D}=this.state,W=this.getSubLayerClass("fill",s.A),M=this.getSubLayerClass("stroke",u.A),T=this.shouldRenderSubLayer("fill",P)&&new W({_dataDiff:t,extruded:o,elevationScale:c,filled:i,wireframe:l,_normalize:a,_windingOrder:r,getElevation:w,getFillColor:A,getLineColor:o&&l?C:g,material:F,transitions:d},this.getSubLayerProps({id:"fill",updateTriggers:k&&{getPolygon:k.getPolygon,getElevation:k.getElevation,getFillColor:k.getFillColor,lineColors:o&&l,getLineColor:k.getLineColor}}),{data:e,positionFormat:h,getPolygon:S});return[!o&&T,!o&&n&&this.shouldRenderSubLayer("stroke",P)&&new M({_dataDiff:D&&(()=>D),widthUnits:p,widthScale:f,widthMinPixels:m,widthMaxPixels:y,jointRounded:_,miterLimit:b,dashJustified:v,_pathType:"loop",transitions:d&&{getWidth:d.getLineWidth,getColor:d.getLineColor,getPath:d.getPolygon},getColor:this.getSubLayerAccessor(C),getWidth:this.getSubLayerAccessor(L),getDashArray:this.getSubLayerAccessor(x)},this.getSubLayerProps({id:"stroke",updateTriggers:k&&{getWidth:k.getLineWidth,getColor:k.getLineColor,getDashArray:k.getLineDashArray}}),{data:P,positionFormat:h,getPath:e=>e.path}),o&&T]}}p.layerName="PolygonLayer",p.defaultProps=h;const f=p;var m=n(66671),y=n(32548),_=n(12619);function b(e,t){return e<t?-1:e>t?1:e>=t?0:NaN}function v(e){let t=e,n=e;function i(e,t,i,o){for(null==i&&(i=0),null==o&&(o=e.length);i<o;){const l=i+o>>>1;n(e[l],t)<0?i=l+1:o=l}return i}return 1===e.length&&(t=(t,n)=>e(t)-n,n=function(e){return(t,n)=>b(e(t),n)}(e)),{left:i,center:function(e,n,o,l){null==o&&(o=0),null==l&&(l=e.length);const a=i(e,n,o,l-1);return a>o&&t(e[a-1],n)>-t(e[a],n)?a-1:a},right:function(e,t,i,o){for(null==i&&(i=0),null==o&&(o=e.length);i<o;){const l=i+o>>>1;n(e[l],t)>0?o=l:i=l+1}return i}}}const A=v(b),C=A.right,L=(A.left,v((function(e){return null===e?NaN:+e})).center,C);function x(e,t){switch(arguments.length){case 0:break;case 1:this.range(e);break;default:this.range(t).domain(e)}return this}function w(){var e,t=[.5],n=[0,1],i=1;function o(o){return null!=o&&o<=o?n[L(t,o,0,i)]:e}return o.domain=function(e){return arguments.length?(t=Array.from(e),i=Math.min(t.length,n.length-1),o):t.slice()},o.range=function(e){return arguments.length?(n=Array.from(e),i=Math.min(t.length,n.length-1),o):n.slice()},o.invertExtent=function(e){var i=n.indexOf(e);return[t[i-1],t[i]]},o.unknown=function(t){return arguments.length?(e=t,o):e},o.copy=function(){return w().domain(t).range(n).unknown(e)},x.apply(o,arguments)}var S=n(30885),k=n(69161),F=n(49443);const P=10;function D({break_points:e,num_buckets:t},n,i){if(!n)return[];if(void 0===e||0===e.length){const e=t?parseInt(t,10):P,[o,l]=(0,_.extent)(n,i).map((e=>"string"==typeof e?parseFloat(e):e));if(void 0===o||void 0===l)return[];const a=(l-o)/e,r=0===a?0:Math.max(0,Math.ceil(Math.log10(1/a))),s=l>parseFloat(l.toFixed(r))?1:0,u=o<parseFloat(o.toFixed(r))?o-1:o;return new Array(e+1+s).fill(0).map(((e,t)=>(u+t*a).toFixed(r)))}return e.sort(((e,t)=>parseFloat(e)-parseFloat(t)))}function W({break_points:e,num_buckets:t,linear_color_scheme:n,opacity:i},o,l){const a=e||t?D({break_points:e,num_buckets:t},o,l):null,r=Array.isArray(n)?new S.A({colors:n,id:"custom"}):(0,k.A)().get(n);if(!r)return null;let s,u;if(null!==a){const e=a.length-1,t=e>1?r.getColors(e):[r.colors[r.colors.length-1]],n=t[0],i=t[t.length-1];t.unshift(n),t.push(i);const o=a.map(parseFloat);s=w().domain(o).range(t),u=t=>!!t&&(t>o[e]||t<o[0])}else{const e=(0,_.extent)(o,l);s=e.some((e=>"number"==typeof e))?r.createLinearScale((0,_.extent)(o,l)):r.createLinearScale(),u=()=>!1}return e=>{const t=l(e);if(!t)return[0,0,0,0];const n=(0,F.hexToRGB)(s(t));return u(t)?n[3]=0:n[3]=i/100*255,n}}var M=n(41857),T=n(25564);function E(e){return"geometry"in e.polygon?e.polygon.geometry.coordinates[0]:e.polygon}var R=n(95490),j=n(70957),z=n(2445);function N(e,t,n,i,l,a){const r=e,s=r.fill_color_picker,u=r.stroke_color_picker;let c=[...t.data.features];r.js_data_mutator&&(c=(0,T.A)(r.js_data_mutator)(c));const d=r.metric?r.metric.label||r.metric:null,g=null===r.metric?()=>[s.r,s.g,s.b,255*s.a]:W(r,c,(e=>e[d])),h=e=>{const t=(null==g?void 0:g(e))||[0,0,0,0];return l.length>0&&!l.includes(e[r.line_column])&&(t[3]/=2),t},p=r.line_column&&r.metric&&["json","geohash","zipcode"].includes(r.line_type)?function(e){return t=>{var n,i,l,a;const r=(null==e||null==(n=e.metric)?void 0:n.label)||(null==e?void 0:e.metric);return(0,z.FD)("div",{className:"deckgl-tooltip",children:[(null==(i=t.object)?void 0:i.name)&&(0,z.Y)(y.A,{label:(0,o.t)("name")+": ",value:`${t.object.name}`}),(null==(l=t.object)?void 0:l[null==e?void 0:e.line_column])&&(0,z.Y)(y.A,{label:`${e.line_column}: `,value:`${t.object[e.line_column]}`}),(null==e?void 0:e.metric)&&(0,z.Y)(y.A,{label:`${r}: `,value:`${null==(a=t.object)?void 0:a[r]}`})]})}}(r):()=>null;return new f({id:`path-layer-${r.slice_id}`,data:c,filled:r.filled,stroked:r.stroked,getPolygon:E,getFillColor:h,getLineColor:[u.r,u.g,u.b,255*u.a],getLineWidth:r.line_width,extruded:r.extruded,lineWidthUnits:r.line_width_unit,getElevation:e=>function(e,t){return 0===t(e)[3]?0:e.elevation}(e,h),elevationScale:r.multiplier,fp64:!0,...(0,M.T)(r,i,p,a)})}function $(e){return e.flatMap(E)}const Y=e=>{const t=(0,i.useRef)(),n=(0,i.useCallback)((()=>{let t={...e.viewport};if(e.formData.autozoom){const n=e.payload.data.features||[];t=(0,R.A)(t,{width:e.width,height:e.height,points:$(n)})}return t.zoom<0&&(t.zoom=0),t}),[e]),[o,l]=(0,i.useState)(0),[a,r]=(0,i.useState)(n()),[s,u]=(0,i.useState)(e.payload.form_data),[c,d]=(0,i.useState)([]);(0,i.useEffect)((()=>{const{payload:t}=e;t.form_data!==s&&(r(n()),d([]),l(0),u(t.form_data))}),[n,e,s,a]);const g=(0,i.useCallback)((e=>{const{current:n}=t;n&&n.setTooltip(e)}),[]),h=(0,i.useCallback)((t=>{const{formData:n,onAddFilter:i}=e,a=(new Date).getDate(),r=a-o<=250,s=[...c];if(r)s.splice(0,s.length,t);else if(n.toggle_polygons){const e=s.indexOf(t);-1===e?s.push(t):s.splice(e,1)}else s.splice(0,1,t);d(s),l(a),n.table_filter&&i(n.line_column,c,!1,!0)}),[o,e,c]),p=(0,i.useCallback)((()=>void 0===e.payload.data.features?[]:[N(e.formData,e.payload,e.onAddFilter,g,c,h)]),[h,e.formData,e.onAddFilter,e.payload,c,g]),{payload:f,formData:y,setControlValue:_}=e,b=y.metric?y.metric.label||y.metric:null,v=function(e,t,n){const i=D(e,t,n),o=W(e,t,n),l={};return i.slice(1).forEach(((t,n)=>{const a=`${i[n]} - ${i[n+1]}`,r=.5*(parseFloat(i[n])+parseFloat(i[n+1])),s=e.metric?e.metric.label||e.metric:null;l[a]={color:null==o?void 0:o({[s||e.metric]:r}),enabled:!0}})),l}(y,f.data.features,(e=>e[b]));return(0,z.FD)("div",{style:{position:"relative"},children:[(0,z.Y)(j.S,{ref:t,viewport:a,layers:p(),setControlValue:_,mapStyle:y.mapbox_style,mapboxApiAccessToken:f.data.mapboxApiKey,width:e.width,height:e.height}),null!==y.metric&&(0,z.Y)(m.A,{categories:v,position:y.legend_position,format:y.legend_format})]})},I=(0,i.memo)(Y)}}]);