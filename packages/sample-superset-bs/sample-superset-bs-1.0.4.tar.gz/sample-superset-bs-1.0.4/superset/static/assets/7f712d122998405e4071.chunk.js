"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[7867],{17786:(e,t,a)=>{a.r(t),a.d(t,{default:()=>Le});var n=a(17437),i=a(58561),s=a.n(i),o=a(96540),r=a(5556),l=a.n(r),d=a(78697),c=a(91162),h=a(25946),p=a(69945),u=a(72391),m=a(96453),g=a(78518),y=a(27366),b=a(35742),f=a(62952),C=a(57940),_=a(51436),v=a(98837),Y=a(15595),A=a(40563),x=a(46920),S=a(48327),D=a(58132),w=a(78704),E=a(47351),T=a(35768),I=a(17444),k=a(8791),F=a(46022),L=a(37648),q=a(4783),M=a(19855),O=a(9379),$=a(5261),z=a(67073),K=a(3173);const R=(0,a(93505).A)({method:"POST",endpoint:"/api/v1/sqllab/execute"});function P(e){return{type:"SET_QUERY_IS_LOADING",payload:e}}var U=a(61225),N=a(6411),Q=a.n(N),H=a(43561),B=a(66537);function j(e,t,a){return o.Children.map(e,(e=>{let n=e;return e&&e.type&&e.type.name===t.name&&(n=(0,o.cloneElement)(e,a(e))),n&&n.props&&n.props.children&&(n=(0,o.cloneElement)(n,{children:j(n.props.children,t,a)})),n}))}var G=a(19129),W=a(2445);const V=n.AH`
  .ant-form-item-control-input-content {
    display: flex;
    flex-direction: row;
  }
`;function J({fieldKey:e,value:t,label:a,description:i=null,control:s,additionalControl:r,onChange:l=()=>{},compact:d=!1,inline:c,errorMessage:h}){const p=(0,o.useCallback)((t=>{l(e,t)}),[l,e]),u=(0,o.cloneElement)(s,{value:t,onChange:p});return(0,W.FD)("div",{css:r&&n.AH`
          position: relative;
        `,children:[r,(0,W.FD)(A.eI,{label:(0,W.FD)(A.lR,{className:"m-r-5",children:[a||e,d&&i&&(0,W.Y)(G.m_,{id:"field-descr",placement:"right",title:i,children:(0,W.Y)(z.F.InfoCircleFilled,{iconSize:"s",className:"m-l-5"})})]}),css:c&&V,children:[u,!d&&i&&(0,W.Y)("div",{css:e=>({color:e.colors.grayscale.base,[c?"marginLeft":"marginTop"]:e.gridUnit}),children:i})]}),h&&(0,W.Y)("div",{css:e=>({color:e.colors.error.base,marginTop:-16,fontSize:e.typography.sizes.s}),children:h})]})}class Z extends o.PureComponent{constructor(e){super(e),this.onChange=this.onChange.bind(this)}onChange(e,t){return this.props.onChange({...this.props.item,[e]:t})}render(){const{title:e}=this.props;return(0,W.FD)(A.lV,{className:"CRUD",layout:"vertical",children:[e&&(0,W.Y)("legend",{children:e}),j(this.props.children,J,(e=>({onChange:this.onChange,value:this.props.item[e.props.fieldKey],compact:this.props.compact})))]})}}var X;function ee(e){const t=e.map((e=>({...e,id:e.id||(0,H.Ak)()}))),a={};return t.forEach((e=>{a[e.id]=e})),{collection:a,collectionArray:t}}Z.defaultProps={compact:!1,title:null},function(e){e[e.Asc=1]="Asc",e[e.Desc=2]="Desc",e[e.Unsorted=0]="Unsorted"}(X||(X={}));const te=m.I4.div`
  ${({stickyHeader:e})=>e&&"\n      height: 350px;\n      overflow-y: auto;\n      overflow-x: auto;\n\n      .table {\n        min-width: 800px;\n      }\n      thead th {\n        background: #fff;\n        position: sticky;\n        top: 0;\n        z-index: 9;\n        min\n      }\n    "}
  ${({theme:e})=>`\n    th span {\n      vertical-align: ${-2*e.gridUnit}px;\n    }\n    .text-right {\n      text-align: right;\n    }\n    .empty-collection {\n      padding: ${2*e.gridUnit+2}px;\n    }\n    .tiny-cell {\n      width: ${e.gridUnit+1}px;\n    }\n    i.fa-caret-down,\n    i.fa-caret-up {\n      width: ${e.gridUnit+1}px;\n    }\n    td.expanded {\n      border-top: 0;\n      padding: 0;\n    }\n  `}
`,ae=m.I4.div`
  text-align: right;
  ${({theme:e})=>`margin-bottom: ${2*e.gridUnit}px`}
`,ne=m.I4.span`
  ${({theme:e})=>`\n    margin-top: ${3*e.gridUnit}px;\n    margin-left: ${3*e.gridUnit}px;\n    button>span>:first-of-type {\n      margin-right: 0;\n    }\n  `}
`;class ie extends o.PureComponent{constructor(e){super(e);const{collection:t,collectionArray:a}=ee(e.collection);this.state={expandedColumns:{},collection:t,collectionArray:a,sortColumn:"",sort:0},this.renderItem=this.renderItem.bind(this),this.onAddItem=this.onAddItem.bind(this),this.renderExpandableSection=this.renderExpandableSection.bind(this),this.getLabel=this.getLabel.bind(this),this.onFieldsetChange=this.onFieldsetChange.bind(this),this.renderTableBody=this.renderTableBody.bind(this),this.changeCollection=this.changeCollection.bind(this),this.sortColumn=this.sortColumn.bind(this),this.renderSortIcon=this.renderSortIcon.bind(this)}UNSAFE_componentWillReceiveProps(e){if(e.collection!==this.props.collection){const{collection:t,collectionArray:a}=ee(e.collection);this.setState({collection:t,collectionArray:a})}}onCellChange(e,t,a){this.changeCollection({...this.state.collection,[e]:{...this.state.collection[e],[t]:a}})}onAddItem(){if(this.props.itemGenerator){let e=this.props.itemGenerator();e.id||(e={...e,id:(0,H.Ak)()}),this.changeCollection(this.state.collection,e)}}onFieldsetChange(e){this.changeCollection({...this.state.collection,[e.id]:e})}getLabel(e){const{columnLabels:t}=this.props;let a=null!=t&&t[e]?t[e]:e;return a.startsWith("__")&&(a=""),a}getTooltip(e){const{columnLabelTooltips:t}=this.props;return null==t?void 0:t[e]}changeCollection(e,t){if(this.setState({collection:e}),this.props.onChange){const a=this.state.collectionArray.map((t=>e[t.id])).filter((e=>void 0!==e));t&&a.unshift(t),this.props.onChange(a)}}deleteItem(e){const t={...this.state.collection};delete t[e],this.changeCollection(t)}effectiveTableColumns(){const{tableColumns:e,allowDeletes:t,expandFieldset:a}=this.props,n=t?e.concat(["__actions"]):e;return a?["__expand"].concat(n):n}toggleExpand(e){this.onCellChange(e,"__expanded",!1),this.setState((t=>({expandedColumns:{...t.expandedColumns,[e]:!t.expandedColumns[e]}})))}sortColumn(e,t=X.Unsorted){const{sortColumns:a}=this.props;return()=>{if(null!=a&&a.includes(e)){if(t===X.Unsorted){const{collection:e}=ee(this.props.collection),a=function(e){return Object.keys(e).map((t=>e[t]))}(e);return void this.setState({collectionArray:a,sortColumn:"",sort:t})}const a=[...this.state.collectionArray].sort(((t,a)=>{return n=t[e],i=a[e],"string"==typeof n?(n||" ").localeCompare(i):n-i;var n,i})),n=t===X.Asc?a:a.reverse();this.setState((a=>({...a,collectionArray:n,sortColumn:e,sort:t})))}}}renderSortIcon(e){return this.state.sortColumn===e&&this.state.sort===X.Asc?(0,W.Y)(z.F.SortAsc,{onClick:this.sortColumn(e,2)}):this.state.sortColumn===e&&this.state.sort===X.Desc?(0,W.Y)(z.F.SortDesc,{onClick:this.sortColumn(e,0)}):(0,W.Y)(z.F.Sort,{onClick:this.sortColumn(e,1)})}renderTH(e,t){const a=this.getTooltip(e);return(0,W.FD)("th",{className:"no-wrap",children:[this.getLabel(e),a&&(0,W.FD)(W.FK,{children:[" ",(0,W.Y)(B.W,{label:(0,g.t)("description"),tooltip:a})]}),(null==t?void 0:t.includes(e))&&this.renderSortIcon(e)]},e)}renderHeaderRow(){const e=this.effectiveTableColumns(),{allowDeletes:t,expandFieldset:a,extraButtons:n,sortColumns:i}=this.props;return(0,W.Y)("thead",{children:(0,W.FD)("tr",{children:[a&&(0,W.Y)("th",{"aria-label":"Expand",className:"tiny-cell"}),e.map((e=>this.renderTH(e,i))),n,t&&(0,W.Y)("th",{"aria-label":"Delete",className:"tiny-cell"},"delete-item")]})})}renderExpandableSection(e){return j(this.props.expandFieldset,Z,(()=>({item:e,onChange:this.onFieldsetChange})))}getCellProps(e,t){var a;const n=null==(a=this.props.itemCellProps)?void 0:a[t],i=e[t];return n?n(i,this.getLabel(t),e):{}}renderCell(e,t){var a;const n=null==(a=this.props.itemRenderers)?void 0:a[t],i=e[t],s=this.onCellChange.bind(this,e.id,t);return n?n(i,s,this.getLabel(t),e):i}renderItem(e){const{allowAddItem:t,allowDeletes:a,expandFieldset:i,tableColumns:s}=this.props,o=!!this.state.expandedColumns[e.id]||e.__expanded;let r=[];i&&r.push((0,W.Y)("td",{className:"expand",children:(0,W.Y)("i",{role:"button","aria-label":"Toggle expand",tabIndex:0,className:`fa fa-caret-${o?"down":"right"} text-primary pointer`,onClick:this.toggleExpand.bind(this,e.id)})},"__expand")),r=r.concat(s.map((t=>(0,n.n)("td",{...this.getCellProps(e,t),key:t},this.renderCell(e,t))))),t&&r.push((0,W.Y)("td",{"aria-label":"Add"},"add")),a&&r.push((0,W.Y)("td",{"data-test":"crud-delete-option",className:"text-primary",children:(0,W.Y)(z.F.DeleteOutlined,{"aria-label":"Delete item",className:"pointer","data-test":"crud-delete-icon",role:"button",tabIndex:0,onClick:this.deleteItem.bind(this,e.id),iconSize:"l"})},"__actions"));const l=[(0,n.n)("tr",{"data-test":"table-row",className:"row",key:e.id},r)];return o&&l.push((0,W.Y)("tr",{className:"exp",children:(0,W.Y)("td",{colSpan:this.effectiveTableColumns().length,className:"expanded",children:(0,W.Y)("div",{children:this.renderExpandableSection(e)})})},`exp__${e.id}`)),l}renderEmptyCell(){return(0,W.Y)("tr",{children:(0,W.Y)("td",{className:"empty-collection",children:this.props.emptyMessage})})}renderTableBody(){const e=this.state.collectionArray,t=e.length?e.map((e=>this.renderItem(e))):this.renderEmptyCell();return(0,W.Y)("tbody",{"data-test":"table-content-rows",children:t})}render(){return(0,W.FD)(W.FK,{children:[(0,W.Y)(ae,{children:this.props.allowAddItem&&(0,W.Y)(ne,{children:(0,W.FD)(x.A,{buttonSize:"small",buttonStyle:"tertiary",onClick:this.onAddItem,"data-test":"add-item-button",children:[(0,W.Y)(z.F.PlusOutlined,{iconSize:"m","data-test":"crud-add-table-item"}),(0,g.t)("Add item")]})})}),(0,W.Y)(te,{className:"CRUD",stickyHeader:this.props.stickyHeader,children:(0,W.FD)("table",{"data-test":"crud-table",className:"table",children:[this.renderHeaderRow(),this.renderTableBody()]})})]})}}var se,oe=a(80037);const re=(0,u.a)(),le=m.I4.div`
  .change-warning {
    margin: 16px 10px 0;
    color: ${({theme:e})=>e.colors.warning.base};
  }

  .change-warning .bold {
    font-weight: ${({theme:e})=>e.typography.weights.bold};
  }

  .form-group.has-feedback > .help-block {
    margin-top: 8px;
  }

  .form-group.form-group-md {
    margin-bottom: 8px;
  }
`,de=m.I4.div`
  align-items: center;
  display: flex;

  svg {
    margin-right: ${({theme:e})=>e.gridUnit}px;
  }
`,ce=(0,m.I4)(S.Ay)`
  overflow: visible;
  .ant-tabs-content-holder {
    overflow: visible;
  }
`,he=(0,m.I4)(p.A)`
  .antd5-badge-count {
    line-height: ${({theme:e})=>4*e.gridUnit}px;
    height: ${({theme:e})=>4*e.gridUnit}px;
    margin-left: ${({theme:e})=>e.gridUnit}px;
  }
`,pe=m.I4.div`
  font-size: ${({theme:e})=>e.typography.sizes.s}px;
  display: flex;
  align-items: center;
  a {
    padding: 0 10px;
  }
`,ue=m.I4.div`
  text-align: right;
  ${({theme:e})=>`margin-bottom: ${2*e.gridUnit}px`}
`,me=m.I4.div`
  display: flex;
  align-items: center;
  span {
    margin-right: ${({theme:e})=>e.gridUnit}px;
  }
`,ge=m.I4.div`
  .table > tbody > tr > td {
    vertical-align: middle;
  }

  .ant-tag {
    margin-top: ${({theme:e})=>e.gridUnit}px;
  }
`,ye=m.I4.span`
  ${({theme:e})=>`\n    margin-top: ${3*e.gridUnit}px;\n    margin-left: ${3*e.gridUnit}px;\n    button>span>:first-of-type {\n      margin-right: 0;\n    }\n  `}
`,be=(e,t)=>(0,W.Y)(L.A,{value:e,onChange:t}),fe=[{value:"STRING",label:(0,g.t)("STRING")},{value:"NUMERIC",label:(0,g.t)("NUMERIC")},{value:"DATETIME",label:(0,g.t)("DATETIME")},{value:"BOOLEAN",label:(0,g.t)("BOOLEAN")}],Ce=[{key:"physical",label:(0,g.t)("Physical (table or view)")},{key:"virtual",label:(0,g.t)("Virtual (SQL)")}],_e={};Ce.forEach((e=>{_e[e.key]=e}));var ve={name:"s5xdrg",styles:"display:flex;align-items:center"};function Ye({title:e,collection:t}){return(0,W.FD)("div",{css:ve,"data-test":`collection-tab-${e}`,children:[e," ",(0,W.Y)(he,{count:t?t.length:0,showZero:!0})]})}function Ae({columns:e,datasource:t,onColumnsChange:a,onDatasourceChange:n,editableColumnName:i,showExpression:s,allowAddItem:o,allowEditDataType:r,itemGenerator:l,columnLabelTooltips:c}){return(0,W.Y)(ie,{tableColumns:(0,y.G7)(y.TO.EnableAdvancedDataTypes)?["column_name","advanced_data_type","type","is_dttm","main_dttm_col","filterable","groupby"]:["column_name","type","is_dttm","main_dttm_col","filterable","groupby"],sortColumns:(0,y.G7)(y.TO.EnableAdvancedDataTypes)?["column_name","advanced_data_type","type","is_dttm","main_dttm_col","filterable","groupby"]:["column_name","type","is_dttm","main_dttm_col","filterable","groupby"],allowDeletes:!0,allowAddItem:o,itemGenerator:l,collection:e,columnLabelTooltips:c,stickyHeader:!0,expandFieldset:(0,W.Y)(Se,{children:(0,W.FD)(Z,{compact:!0,children:[s&&(0,W.Y)(J,{fieldKey:"expression",label:(0,g.t)("SQL expression"),control:(0,W.Y)(M.A,{language:"markdown",offerEditInModal:!1,resize:"vertical"})}),(0,W.Y)(J,{fieldKey:"verbose_name",label:(0,g.t)("Label"),control:(0,W.Y)(q.A,{controlId:"verbose_name",placeholder:(0,g.t)("Label")})}),(0,W.Y)(J,{fieldKey:"description",label:(0,g.t)("Description"),control:(0,W.Y)(q.A,{controlId:"description",placeholder:(0,g.t)("Description")})}),r&&(0,W.Y)(J,{fieldKey:"type",label:(0,g.t)("Data type"),control:(0,W.Y)(Y.l6,{ariaLabel:(0,g.t)("Data type"),options:fe,name:"type",allowNewOptions:!0,allowClear:!0})}),(0,y.G7)(y.TO.EnableAdvancedDataTypes)?(0,W.Y)(J,{fieldKey:"advanced_data_type",label:(0,g.t)("Advanced data type"),control:(0,W.Y)(q.A,{controlId:"advanced_data_type",placeholder:(0,g.t)("Advanced Data type")})}):(0,W.Y)(W.FK,{}),(0,W.Y)(J,{fieldKey:"python_date_format",label:(0,g.t)("Datetime format"),description:(0,W.FD)("div",{children:[(0,g.t)("The pattern of timestamp format. For strings use "),(0,W.Y)("a",{href:"https://docs.python.org/2/library/datetime.html#strftime-strptime-behavior",children:(0,g.t)("Python datetime string pattern")}),(0,g.t)(" expression which needs to adhere to the "),(0,W.Y)("a",{href:"https://en.wikipedia.org/wiki/ISO_8601",children:(0,g.t)("ISO 8601")}),(0,g.t)(" standard to ensure that the lexicographical ordering\n                      coincides with the chronological ordering. If the\n                      timestamp format does not adhere to the ISO 8601 standard\n                      you will need to define an expression and type for\n                      transforming the string into a date or timestamp. Note\n                      currently time zones are not supported. If time is stored\n                      in epoch format, put `epoch_s` or `epoch_ms`. If no pattern\n                      is specified we fall back to using the optional defaults on a per\n                      database/column name level via the extra parameter.")]}),control:(0,W.Y)(q.A,{controlId:"python_date_format",placeholder:"%Y-%m-%d"})}),(0,W.Y)(J,{fieldKey:"certified_by",label:(0,g.t)("Certified By"),description:(0,g.t)("Person or group that has certified this metric"),control:(0,W.Y)(q.A,{controlId:"certified",placeholder:(0,g.t)("Certified by")})}),(0,W.Y)(J,{fieldKey:"certification_details",label:(0,g.t)("Certification details"),description:(0,g.t)("Details of the certification"),control:(0,W.Y)(q.A,{controlId:"certificationDetails",placeholder:(0,g.t)("Certification details")})})]})}),columnLabels:(0,y.G7)(y.TO.EnableAdvancedDataTypes)?{column_name:(0,g.t)("Column"),advanced_data_type:(0,g.t)("Advanced data type"),type:(0,g.t)("Data type"),groupby:(0,g.t)("Is dimension"),is_dttm:(0,g.t)("Is temporal"),main_dttm_col:(0,g.t)("Default datetime"),filterable:(0,g.t)("Is filterable")}:{column_name:(0,g.t)("Column"),type:(0,g.t)("Data type"),groupby:(0,g.t)("Is dimension"),is_dttm:(0,g.t)("Is temporal"),main_dttm_col:(0,g.t)("Default datetime"),filterable:(0,g.t)("Is filterable")},onChange:a,itemRenderers:(0,y.G7)(y.TO.EnableAdvancedDataTypes)?{column_name:(e,t,a,n)=>i?(0,W.FD)(me,{children:[n.is_certified&&(0,W.Y)(D.A,{certifiedBy:n.certified_by,details:n.certification_details}),(0,W.Y)(F.A,{canEdit:!0,title:e,onSaveTitle:t})]}):(0,W.FD)(me,{children:[n.is_certified&&(0,W.Y)(D.A,{certifiedBy:n.certified_by,details:n.certification_details}),e]}),main_dttm_col:(a,i,s,o)=>{const r=t.main_dttm_col===o.column_name,l=!e.find((e=>e.column_name===o.column_name)).is_dttm;return(0,W.Y)(d.s,{"aria-label":(0,g.t)("Set %s as default datetime column",o.column_name),"data-test":`radio-default-dttm-${o.column_name}`,checked:r,disabled:l,onChange:()=>n({...t,main_dttm_col:o.column_name})})},type:e=>e?(0,W.Y)(T.Ay,{children:e}):null,advanced_data_type:e=>(0,W.Y)(T.Ay,{onChange:a,children:e}),is_dttm:be,filterable:be,groupby:be}:{column_name:(e,t,a,n)=>i?(0,W.FD)(me,{children:[n.is_certified&&(0,W.Y)(D.A,{certifiedBy:n.certified_by,details:n.certification_details}),(0,W.Y)(q.A,{value:e,onChange:t})]}):(0,W.FD)(me,{children:[n.is_certified&&(0,W.Y)(D.A,{certifiedBy:n.certified_by,details:n.certification_details}),e]}),main_dttm_col:(a,i,s,o)=>{const r=t.main_dttm_col===o.column_name,l=!e.find((e=>e.column_name===o.column_name)).is_dttm;return(0,W.Y)(d.s,{"aria-label":(0,g.t)("Set %s as default datetime column",o.column_name),"data-test":`radio-default-dttm-${o.column_name}`,checked:r,disabled:l,onChange:()=>n({...t,main_dttm_col:o.column_name})})},type:e=>e?(0,W.Y)(T.Ay,{children:e}):null,is_dttm:be,filterable:be,groupby:be}})}function xe({label:e,formElement:t}){return(0,W.FD)("div",{children:[(0,W.Y)("div",{children:(0,W.Y)("strong",{children:e})}),(0,W.Y)("div",{children:t})]})}function Se({children:e}){return(0,W.Y)(c.A,{padded:!0,children:e})}Ye.propTypes={title:l().string,collection:l().array},Ae.propTypes={columns:l().array.isRequired,datasource:l().object.isRequired,onColumnsChange:l().func.isRequired,onDatasourceChange:l().func.isRequired,editableColumnName:l().bool,showExpression:l().bool,allowAddItem:l().bool,allowEditDataType:l().bool,itemGenerator:l().func},Ae.defaultProps={editableColumnName:!1,showExpression:!1,allowAddItem:!1,allowEditDataType:!1,itemGenerator:()=>({column_name:(0,g.t)("<new column>"),filterable:!0,groupby:!0})},xe.propTypes={label:l().string,formElement:l().node},Se.propTypes={children:l().node};const De={datasource:l().object.isRequired,onChange:l().func,addSuccessToast:l().func.isRequired,addDangerToast:l().func.isRequired,setIsEditing:l().func};function we({datasource:e,onChange:t}){const a=(0,o.useCallback)(((e="",t,a)=>{const n=s().encode({filter:e,page:t,page_size:a});return b.A.get({endpoint:`/api/v1/dataset/related/owners?q=${n}`}).then((e=>({data:e.json.result.filter((e=>e.extra.active)).map((e=>({value:e.value,label:e.text}))),totalCount:e.json.count})))}),[]);return(0,W.Y)(Y.DW,{ariaLabel:(0,g.t)("Select owners"),mode:"multiple",name:"owners",value:e.owners,options:a,onChange:t,header:(0,W.Y)(A.lR,{children:(0,g.t)("Owners")}),allowClear:!0})}const Ee=null!=(se=re.get("sqleditor.extension.resultTable"))?se:oe.A;var Te={name:"hkh81z",styles:"margin-top:8px"},Ie={name:"hkh81z",styles:"margin-top:8px"};class ke extends o.PureComponent{constructor(e){var t;super(e),this.renderSqlEditorOverlay=()=>(0,W.Y)("div",{css:e=>n.AH`
        position: absolute;
        background: ${e.colors.secondary.light5};
        align-items: center;
        display: flex;
        height: 100%;
        width: 100%;
        justify-content: center;
      `,children:(0,W.FD)("div",{children:[(0,W.Y)(I.A,{position:"inline-centered"}),(0,W.Y)("span",{css:e=>n.AH`
            display: block;
            margin: ${4*e.gridUnit}px auto;
            width: fit-content;
            color: ${e.colors.grayscale.base};
          `,children:(0,g.t)("We are working on your query")})]})}),this.renderSqlErrorMessage=()=>{var e;return(0,W.FD)(W.FK,{children:[(0,W.Y)("span",{css:e=>n.AH`
          font-size: ${e.typography.sizes.s}px;
        `,children:(null==(e=this.props.database)?void 0:e.error)&&(0,g.t)("Error executing query. ")}),this.renderOpenInSqlLabLink(!0),(0,W.Y)("span",{css:e=>n.AH`
          font-size: ${e.typography.sizes.s}px;
        `,children:(0,g.t)(" to check for details.")})]})},this.state={datasource:{...e.datasource,owners:e.datasource.owners.map((e=>({value:e.value||e.id,label:e.label||`${e.first_name} ${e.last_name}`}))),metrics:null==(t=e.datasource.metrics)?void 0:t.map((e=>{const{certified_by:t,certification_details:a}=e,{certification:{details:n,certified_by:i}={},warning_markdown:s}=JSON.parse(e.extra||"{}")||{};return{...e,certification_details:a||n,warning_markdown:s||"",certified_by:i||t}}))},errors:[],isSqla:"table"===e.datasource.datasource_type||"table"===e.datasource.type,isEditMode:!1,databaseColumns:e.datasource.columns.filter((e=>!e.expression)),calculatedColumns:e.datasource.columns.filter((e=>!!e.expression)),metadataLoading:!1,activeTabKey:0,datasourceType:e.datasource.sql?_e.virtual.key:_e.physical.key},this.onChange=this.onChange.bind(this),this.onChangeEditMode=this.onChangeEditMode.bind(this),this.onDatasourcePropChange=this.onDatasourcePropChange.bind(this),this.onDatasourceChange=this.onDatasourceChange.bind(this),this.tableChangeAndSyncMetadata=this.tableChangeAndSyncMetadata.bind(this),this.syncMetadata=this.syncMetadata.bind(this),this.setColumns=this.setColumns.bind(this),this.validateAndChange=this.validateAndChange.bind(this),this.handleTabSelect=this.handleTabSelect.bind(this),this.formatSql=this.formatSql.bind(this),this.currencies=(0,f.A)(e.currencies).map((e=>({value:e,label:`${(0,C.Q)({symbol:e})} (${e})`})))}onChange(){const{datasourceType:e,datasource:t}=this.state,a=e===_e.physical.key?"":t.sql,n={...this.state.datasource,sql:a,columns:[...this.state.databaseColumns,...this.state.calculatedColumns]};this.props.onChange(n,this.state.errors)}onChangeEditMode(){this.props.setIsEditing(!this.state.isEditMode),this.setState((e=>({isEditMode:!e.isEditMode})))}onDatasourceChange(e,t=this.validateAndChange){this.setState({datasource:e},t)}onDatasourcePropChange(e,t){if(void 0===t)return;const a={...this.state.datasource,[e]:t};this.setState((a=>({datasource:{...a.datasource,[e]:t}})),"table_name"===e?this.onDatasourceChange(a,this.tableChangeAndSyncMetadata):this.onDatasourceChange(a,this.validateAndChange))}onDatasourceTypeChange(e){this.setState({datasourceType:e})}setColumns(e){this.setState(e,this.validateAndChange)}validateAndChange(){this.validate(this.onChange)}async onQueryRun(){this.props.runQuery({client_id:this.props.clientId,database_id:this.state.datasource.database.id,json:!0,runAsync:!1,catalog:this.state.datasource.catalog,schema:this.state.datasource.schema,sql:this.state.datasource.sql,tmp_table_name:"",select_as_cta:!1,ctas_method:"TABLE",queryLimit:25,expand_data:!0})}async onQueryFormat(){const{datasource:e}=this.state;if(e.sql&&this.state.isEditMode)try{const t=await this.props.formatQuery(e.sql);this.onDatasourcePropChange("sql",t.json.result),this.props.addSuccessToast((0,g.t)("SQL was formatted"))}catch(e){const{error:t,statusText:a}=await(0,_.h4)(e);this.props.addDangerToast(t||a||(0,g.t)("An error occurred while formatting SQL"))}}getSQLLabUrl(){return`/sqllab/?${new URLSearchParams({dbid:this.state.datasource.database.id,sql:this.state.datasource.sql,name:this.state.datasource.datasource_name,schema:this.state.datasource.schema,autorun:!0,isDataset:!0}).toString()}`}openOnSqlLab(){window.open(this.getSQLLabUrl(),"_blank","noopener,noreferrer")}tableChangeAndSyncMetadata(){this.validate((()=>{this.syncMetadata(),this.onChange()}))}async formatSql(){const{datasource:e}=this.state;if(e.sql)try{const t=await b.A.post({endpoint:"/api/v1/sql/format",body:JSON.stringify({sql:e.sql}),headers:{"Content-Type":"application/json"}});this.onDatasourcePropChange("sql",t.json.result),this.props.addSuccessToast((0,g.t)("SQL was formatted"))}catch(e){const{error:t,statusText:a}=await(0,_.h4)(e);this.props.addDangerToast(t||a||(0,g.t)("An error occurred while formatting SQL"))}}async syncMetadata(){const{datasource:e}=this.state;this.setState({metadataLoading:!0});try{const t=await async function(e){var t,a;const n={datasource_type:e.type||e.datasource_type,database_name:(null==(t=e.database)?void 0:t.database_name)||(null==(a=e.database)?void 0:a.name),catalog_name:e.catalog,schema_name:e.schema,table_name:e.table_name,normalize_columns:e.normalize_columns,always_filter_main_dttm:e.always_filter_main_dttm};Object.entries(n).forEach((([e,t])=>{void 0===t&&(n[e]=null)}));const i=`/datasource/external_metadata_by_name/?q=${s().encode_uri(n)}`,{json:o}=await b.A.get({endpoint:i});return o}(e),a=function(e,t,a){const n=t.map((e=>e.column_name)),i=e.reduce(((e,t)=>(e[t.column_name]=t,e)),{}),s={added:[],modified:[],removed:e.filter((e=>!(e.expression||n.includes(e.column_name)))).map((e=>e.column_name)),finalColumns:[]};return t.forEach((e=>{const t=i[e.column_name];t?t.type!==e.type||t.is_dttm!==e.is_dttm?(s.finalColumns.push({...t,type:e.type,is_dttm:t.is_dttm||e.is_dttm}),s.modified.push(e.column_name)):s.finalColumns.push(t):(s.finalColumns.push({id:(0,H.Ak)(),column_name:e.column_name,type:e.type,groupby:!0,filterable:!0,is_dttm:e.is_dttm}),s.added.push(e.column_name))})),e.filter((e=>e.expression)).forEach((e=>{s.finalColumns.push(e)})),s.modified.length&&a((0,g.tn)("Modified 1 column in the virtual dataset","Modified %s columns in the virtual dataset",s.modified.length,s.modified.length)),s.removed.length&&a((0,g.tn)("Removed 1 column from the virtual dataset","Removed %s columns from the virtual dataset",s.removed.length,s.removed.length)),s.added.length&&a((0,g.tn)("Added 1 new column to the virtual dataset","Added %s new columns to the virtual dataset",s.added.length,s.added.length)),s}(e.columns,t,this.props.addSuccessToast);this.setColumns({databaseColumns:a.finalColumns.filter((e=>!e.expression))}),this.props.addSuccessToast((0,g.t)("Metadata has been synced")),this.setState({metadataLoading:!1})}catch(e){const{error:t,statusText:a}=await(0,_.h4)(e);this.props.addDangerToast(t||a||(0,g.t)("An error has occurred")),this.setState({metadataLoading:!1})}}findDuplicates(e,t){const a={},n=[];return e.forEach((e=>{const i=t(e);i in a?n.push(i):a[i]=null})),n}validate(e){let t,a=[];const{datasource:n}=this.state;t=this.findDuplicates(n.columns,(e=>e.column_name)),a=a.concat(t.map((e=>(0,g.t)("Column name [%s] is duplicated",e)))),t=this.findDuplicates(n.metrics,(e=>e.metric_name)),a=a.concat(t.map((e=>(0,g.t)("Metric name [%s] is duplicated",e))));const i=this.state.calculatedColumns.filter((e=>!e.expression&&!e.json));a=a.concat(i.map((e=>(0,g.t)("Calculated column [%s] requires an expression",e.column_name))));try{var s;null==(s=this.state.datasource.metrics)||s.forEach((e=>{var t;return(null==(t=e.currency)?void 0:t.symbol)&&new Intl.NumberFormat("en-US",{style:"currency",currency:e.currency.symbol})}))}catch{a=a.concat([(0,g.t)("Invalid currency code in saved metrics")])}this.setState({errors:a},e)}handleTabSelect(e){this.setState({activeTabKey:e})}sortMetrics(e){return e.sort((({id:e},{id:t})=>t-e))}renderSettingsFieldset(){const{datasource:e}=this.state;return(0,W.FD)(Z,{title:(0,g.t)("Basic"),item:e,onChange:this.onDatasourceChange,children:[(0,W.Y)(J,{fieldKey:"description",label:(0,g.t)("Description"),control:(0,W.Y)(M.A,{language:"markdown",offerEditInModal:!1,resize:"vertical"})}),(0,W.Y)(J,{fieldKey:"default_endpoint",label:(0,g.t)("Default URL"),description:(0,g.t)("Default URL to redirect to when accessing from the dataset list page.\n            Accepts relative URLs such as <span style=„white-space: nowrap;”>/superset/dashboard/{id}/</span>"),control:(0,W.Y)(q.A,{controlId:"default_endpoint"})}),(0,W.Y)(J,{inline:!0,fieldKey:"filter_select_enabled",label:(0,g.t)("Autocomplete filters"),description:(0,g.t)("Whether to populate autocomplete filters options"),control:(0,W.Y)(L.A,{})}),this.state.isSqla&&(0,W.Y)(J,{fieldKey:"fetch_values_predicate",label:(0,g.t)("Autocomplete query predicate"),description:(0,g.t)('When using "Autocomplete filters", this can be used to improve performance of the query fetching the values. Use this option to apply a predicate (WHERE clause) to the query selecting the distinct values from the table. Typically the intent would be to limit the scan by applying a relative time filter on a partitioned or indexed time-related field.'),control:(0,W.Y)(M.A,{language:"sql",controlId:"fetch_values_predicate",minLines:5,resize:"vertical"})}),this.state.isSqla&&(0,W.Y)(J,{fieldKey:"extra",label:(0,g.t)("Extra"),description:(0,g.t)('Extra data to specify table metadata. Currently supports metadata of the format: `{ "certification": { "certified_by": "Data Platform Team", "details": "This table is the source of truth." }, "warning_markdown": "This is a warning." }`.'),control:(0,W.Y)(M.A,{controlId:"extra",language:"json",offerEditInModal:!1,resize:"vertical"})}),(0,W.Y)(we,{datasource:e,onChange:t=>{this.onDatasourceChange({...e,owners:t})}})]})}renderAdvancedFieldset(){const{datasource:e}=this.state;return(0,W.FD)(Z,{title:(0,g.t)("Advanced"),item:e,onChange:this.onDatasourceChange,children:[(0,W.Y)(J,{fieldKey:"cache_timeout",label:(0,g.t)("Cache timeout"),description:(0,g.t)("The duration of time in seconds before the cache is invalidated. Set to -1 to bypass the cache."),control:(0,W.Y)(q.A,{controlId:"cache_timeout"})}),(0,W.Y)(J,{fieldKey:"offset",label:(0,g.t)("Hours offset"),control:(0,W.Y)(q.A,{controlId:"offset"}),description:(0,g.t)("The number of hours, negative or positive, to shift the time column. This can be used to move UTC time to local time.")}),this.state.isSqla&&(0,W.Y)(J,{fieldKey:"template_params",label:(0,g.t)("Template parameters"),description:(0,g.t)("A set of parameters that become available in the query using Jinja templating syntax"),control:(0,W.Y)(q.A,{controlId:"template_params"})}),(0,W.Y)(J,{inline:!0,fieldKey:"normalize_columns",label:(0,g.t)("Normalize column names"),description:(0,g.t)("Allow column names to be changed to case insensitive format, if supported (e.g. Oracle, Snowflake)."),control:(0,W.Y)(L.A,{controlId:"normalize_columns"})}),(0,W.Y)(J,{inline:!0,fieldKey:"always_filter_main_dttm",label:(0,g.t)("Always filter main datetime column"),description:(0,g.t)("When the secondary temporal columns are filtered, apply the same filter to the main datetime column."),control:(0,W.Y)(L.A,{controlId:"always_filter_main_dttm"})})]})}renderSpatialTab(){const{datasource:e}=this.state,{spatials:t,all_cols:a}=e;return(0,W.Y)(S.Ay.TabPane,{tab:(0,W.Y)(Ye,{collection:t,title:(0,g.t)("Spatial")}),children:(0,W.Y)(ie,{tableColumns:["name","config"],onChange:this.onDatasourcePropChange.bind(this,"spatials"),itemGenerator:()=>({name:(0,g.t)("<new spatial>"),type:(0,g.t)("<no type>"),config:null}),collection:t,allowDeletes:!0,itemRenderers:{name:(e,t)=>(0,W.Y)(F.A,{canEdit:!0,title:e,onSaveTitle:t}),config:(e,t)=>(0,W.Y)(O.A,{value:e,onChange:t,choices:a})}})},4)}renderOpenInSqlLabLink(e=!1){return(0,W.Y)("a",{href:this.getSQLLabUrl(),target:"_blank",rel:"noopener noreferrer",css:t=>n.AH`
          color: ${e?t.colors.error.base:t.colors.grayscale.base};
          font-size: ${t.typography.sizes.s}px;
          text-decoration: underline;
        `,children:(0,g.t)("Open in SQL lab")})}renderSourceFieldset(){var e,t,a,i,s,o,r,l,c,h,p,u;const{datasource:m}=this.state,y=n.AH`
      align-self: flex-end;
      height: 24px;
      padding-left: 6px;
      padding-right: 6px;
    `;return(0,W.FD)("div",{children:[(0,W.FD)(pe,{children:[(0,W.Y)("span",{role:"button",tabIndex:0,onClick:this.onChangeEditMode,children:this.state.isEditMode?(0,W.Y)(z.F.UnlockOutlined,{iconSize:"xl",css:e=>n.AH`
                  margin: auto ${e.gridUnit}px auto 0;
                `}):(0,W.Y)(z.F.LockOutlined,{iconSize:"xl",css:e=>({margin:`auto ${e.gridUnit}px auto 0`})})}),!this.state.isEditMode&&(0,W.Y)("div",{children:(0,g.t)("Click the lock to make changes.")}),this.state.isEditMode&&(0,W.Y)("div",{children:(0,g.t)("Click the lock to prevent further changes.")})]}),(0,W.Y)("div",{className:"m-l-10 m-t-20 m-b-10",children:Ce.map((e=>(0,W.Y)(d.s,{value:e.key,inline:!0,onChange:this.onDatasourceTypeChange.bind(this,e.key),checked:this.state.datasourceType===e.key,disabled:!this.state.isEditMode,children:e.label},e.key)))}),(0,W.Y)("hr",{}),(0,W.FD)(Z,{item:m,onChange:this.onDatasourceChange,compact:!0,children:[this.state.datasourceType===_e.virtual.key&&(0,W.Y)("div",{children:this.state.isSqla&&(0,W.FD)(W.FK,{children:[(0,W.FD)(Y.fv,{xs:24,md:12,children:[(0,W.Y)(J,{fieldKey:"databaseSelector",label:(0,g.t)("Virtual"),control:(0,W.Y)("div",{css:Te,children:(0,W.Y)(E.A,{db:null==m?void 0:m.database,catalog:m.catalog,schema:m.schema,onCatalogChange:e=>this.state.isEditMode&&this.onDatasourcePropChange("catalog",e),onSchemaChange:e=>this.state.isEditMode&&this.onDatasourcePropChange("schema",e),onDbChange:e=>this.state.isEditMode&&this.onDatasourcePropChange("database",e),formMode:!1,handleError:this.props.addDangerToast,readOnly:!this.state.isEditMode})})}),(0,W.Y)("div",{css:(0,n.AH)({width:"calc(100% - 34px)",marginTop:-16},"",""),children:(0,W.Y)(J,{fieldKey:"table_name",label:(0,g.t)("Name"),control:(0,W.Y)(q.A,{controlId:"table_name",onChange:e=>{this.onDatasourcePropChange("table_name",e)},placeholder:(0,g.t)("Dataset name"),disabled:!this.state.isEditMode})})})]}),(0,W.Y)(J,{fieldKey:"sql",label:(0,g.t)("SQL"),description:(0,g.t)("When specifying SQL, the datasource acts as a view. Superset will use this statement as a subquery while grouping and filtering on the generated parent queries.If changes are made to your SQL query, columns in your dataset will be synced when saving the dataset."),control:null!=(e=this.props.database)&&e.isLoading?(0,W.FD)(W.FK,{children:[this.renderSqlEditorOverlay(),(0,W.Y)(M.A,{hotkeys:[{name:"formatQuery",key:"ctrl+shift+f",descr:(0,g.t)("Format SQL query"),func:()=>{this.onQueryFormat()}}],language:"sql",offerEditInModal:!1,minLines:10,maxLines:1/0,readOnly:!this.state.isEditMode,resize:"both"})]}):(0,W.Y)(M.A,{hotkeys:[{name:"formatQuery",key:"ctrl+shift+f",descr:(0,g.t)("Format SQL query"),func:()=>{this.onQueryFormat()}}],language:"sql",offerEditInModal:!1,minLines:10,maxLines:1/0,readOnly:!this.state.isEditMode,resize:"both"}),additionalControl:(0,W.FD)("div",{css:n.AH`
                          position: absolute;
                          right: 0;
                          top: 0;
                          z-index: 2;
                          display: flex;
                        `,children:[(0,W.Y)(x.A,{disabled:null==(t=this.props.database)?void 0:t.isLoading,tooltip:(0,g.t)("Open SQL Lab in a new tab"),css:y,size:"small",onClick:()=>{this.openOnSqlLab()},children:(0,W.Y)(z.F.ExportOutlined,{iconSize:"s",css:e=>({color:e.colors.primary.dark1})})}),(0,W.Y)(x.A,{disabled:null==(a=this.props.database)?void 0:a.isLoading,tooltip:(0,g.t)("Run query"),css:y,size:"small",buttonStyle:"primary",onClick:()=>{this.onQueryRun()},children:(0,W.Y)(z.F.CaretRightFilled,{iconSize:"s",css:e=>({color:e.colors.grayscale.light5})})})]}),errorMessage:(null==(i=this.props.database)?void 0:i.error)&&this.renderSqlErrorMessage()}),(null==(s=this.props.database)?void 0:s.queryResult)&&(0,W.FD)(W.FK,{children:[(0,W.FD)("div",{css:e=>n.AH`
                          margin-bottom: ${4*e.gridUnit}px;
                        `,children:[(0,W.Y)("span",{css:e=>n.AH`
                            color: ${e.colors.grayscale.base};
                            font-size: ${e.typography.sizes.s}px;
                          `,children:(0,g.t)("In this view you can preview the first 25 rows. ")}),this.renderOpenInSqlLabLink(),(0,W.Y)("span",{css:e=>n.AH`
                            color: ${e.colors.grayscale.base};
                            font-size: ${e.typography.sizes.s}px;
                          `,children:(0,g.t)(" to see details.")})]}),(0,W.Y)(Ee,{data:null==(o=this.props.database)?void 0:o.queryResult.data,queryId:null==(r=this.props.database)?void 0:r.queryResult.query.id,orderedColumnKeys:null==(l=this.props.database)?void 0:l.queryResult.columns.map((e=>e.column_name)),expandedColumns:null==(c=this.props.database)?void 0:c.queryResult.expandedColumns,height:300,allowHTML:!0})]})]})}),this.state.datasourceType===_e.physical.key&&(0,W.Y)(Y.fv,{xs:24,md:12,children:this.state.isSqla&&(0,W.Y)(J,{fieldKey:"tableSelector",label:(0,g.t)("Physical"),control:(0,W.Y)("div",{css:Ie,children:(0,W.Y)(k.Ay,{clearable:!1,database:{...m.database,database_name:(null==(h=m.database)?void 0:h.database_name)||(null==(p=m.database)?void 0:p.name)},dbId:null==(u=m.database)?void 0:u.id,handleError:this.props.addDangerToast,catalog:m.catalog,schema:m.schema,sqlLabMode:!1,tableValue:m.table_name,onCatalogChange:this.state.isEditMode?e=>this.onDatasourcePropChange("catalog",e):void 0,onSchemaChange:this.state.isEditMode?e=>this.onDatasourcePropChange("schema",e):void 0,onDbChange:this.state.isEditMode?e=>this.onDatasourcePropChange("database",e):void 0,onTableSelectChange:this.state.isEditMode?e=>this.onDatasourcePropChange("table_name",e):void 0,readOnly:!this.state.isEditMode})}),description:(0,g.t)("The pointer to a physical table (or view). Keep in mind that the chart is associated to this Superset logical table, and this logical table points the physical table referenced here.")})})]})]})}renderErrors(){return this.state.errors.length>0?(0,W.Y)(h.A,{css:e=>({marginBottom:4*e.gridUnit}),type:"error",message:(0,W.Y)(W.FK,{children:this.state.errors.map((e=>(0,W.Y)("div",{children:e},e)))})}):null}renderMetricCollection(){const{datasource:e}=this.state,{metrics:t}=e,a=null!=t&&t.length?this.sortMetrics(t):[];return(0,W.Y)(ie,{tableColumns:["metric_name","verbose_name","expression"],sortColumns:["metric_name","verbose_name","expression"],columnLabels:{metric_name:(0,g.t)("Metric Key"),verbose_name:(0,g.t)("Label"),expression:(0,g.t)("SQL expression")},columnLabelTooltips:{metric_name:(0,g.t)("This field is used as a unique identifier to attach the metric to charts. It is also used as the alias in the SQL query.")},expandFieldset:(0,W.Y)(Se,{children:(0,W.FD)(Z,{compact:!0,children:[(0,W.Y)(J,{fieldKey:"description",label:(0,g.t)("Description"),control:(0,W.Y)(q.A,{controlId:"description",placeholder:(0,g.t)("Description")})}),(0,W.Y)(J,{fieldKey:"d3format",label:(0,g.t)("D3 format"),control:(0,W.Y)(q.A,{controlId:"d3format",placeholder:"%y/%m/%d"})}),(0,W.Y)(J,{fieldKey:"currency",label:(0,g.t)("Metric currency"),control:(0,W.Y)(K.A,{currencySelectOverrideProps:{placeholder:(0,g.t)("Select or type currency symbol")},symbolSelectAdditionalStyles:n.AH`
                      max-width: 30%;
                    `})}),(0,W.Y)(J,{label:(0,g.t)("Certified by"),fieldKey:"certified_by",description:(0,g.t)("Person or group that has certified this metric"),control:(0,W.Y)(q.A,{controlId:"certified_by",placeholder:(0,g.t)("Certified by")})}),(0,W.Y)(J,{label:(0,g.t)("Certification details"),fieldKey:"certification_details",description:(0,g.t)("Details of the certification"),control:(0,W.Y)(q.A,{controlId:"certification_details",placeholder:(0,g.t)("Certification details")})}),(0,W.Y)(J,{label:(0,g.t)("Warning"),fieldKey:"warning_markdown",description:(0,g.t)("Optional warning about use of this metric"),control:(0,W.Y)(M.A,{controlId:"warning_markdown",language:"markdown",offerEditInModal:!1,resize:"vertical"})})]})}),collection:a,allowAddItem:!0,onChange:this.onDatasourcePropChange.bind(this,"metrics"),itemGenerator:()=>({metric_name:(0,g.t)("<new metric>"),verbose_name:"",expression:""}),itemCellProps:{expression:()=>({width:"240px"})},itemRenderers:{metric_name:(e,t,a,n)=>(0,W.FD)(de,{children:[n.is_certified&&(0,W.Y)(D.A,{certifiedBy:n.certified_by,details:n.certification_details}),n.warning_markdown&&(0,W.Y)(w.A,{warningMarkdown:n.warning_markdown}),(0,W.Y)(F.A,{canEdit:!0,title:e,onSaveTitle:t})]}),verbose_name:(e,t)=>(0,W.Y)(q.A,{canEdit:!0,value:e,onChange:t}),expression:(e,t)=>(0,W.Y)(M.A,{canEdit:!0,initialValue:e,onChange:t,extraClasses:["datasource-sql-expression"],language:"sql",offerEditInModal:!1,minLines:5,textAreaStyles:{minWidth:"200px",maxWidth:"450px"},resize:"both"}),description:(e,t,a)=>(0,W.Y)(xe,{label:a,formElement:(0,W.Y)(q.A,{value:e,onChange:t})}),d3format:(e,t,a)=>(0,W.Y)(xe,{label:a,formElement:(0,W.Y)(q.A,{value:e,onChange:t})})},allowDeletes:!0,stickyHeader:!0})}render(){const{datasource:e,activeTabKey:t}=this.state,{metrics:a}=e,n=null!=a&&a.length?this.sortMetrics(a):[],{theme:i}=this.props;return(0,W.FD)(le,{"data-test":"datasource-editor",children:[this.renderErrors(),(0,W.Y)(h.A,{css:e=>({marginBottom:4*e.gridUnit}),type:"warning",message:(0,W.FD)(W.FK,{children:[" ",(0,W.FD)("strong",{children:[(0,g.t)("Be careful.")," "]}),(0,g.t)("Changing these settings will affect all charts using this dataset, including charts owned by other people.")]})}),(0,W.FD)(ce,{fullWidth:!1,id:"table-tabs","data-test":"edit-dataset-tabs",onChange:this.handleTabSelect,defaultActiveKey:t,children:[(0,W.Y)(S.Ay.TabPane,{tab:(0,g.t)("Source"),children:this.renderSourceFieldset(i)},0),(0,W.Y)(S.Ay.TabPane,{tab:(0,W.Y)(Ye,{collection:n,title:(0,g.t)("Metrics")}),children:this.renderMetricCollection()},1),(0,W.Y)(S.Ay.TabPane,{tab:(0,W.Y)(Ye,{collection:this.state.databaseColumns,title:(0,g.t)("Columns")}),children:(0,W.FD)(ge,{children:[(0,W.Y)(ue,{children:(0,W.Y)(ye,{children:(0,W.FD)(x.A,{buttonSize:"small",buttonStyle:"tertiary",onClick:this.syncMetadata,className:"sync-from-source",disabled:this.state.isEditMode,children:[(0,W.Y)(z.F.DatabaseOutlined,{iconSize:"m"}),(0,g.t)("Sync columns from source")]})})}),(0,W.Y)(Ae,{className:"columns-table",columns:this.state.databaseColumns,datasource:e,onColumnsChange:e=>this.setColumns({databaseColumns:e}),onDatasourceChange:this.onDatasourceChange}),this.state.metadataLoading&&(0,W.Y)(I.A,{})]})},2),(0,W.Y)(S.Ay.TabPane,{tab:(0,W.Y)(Ye,{collection:this.state.calculatedColumns,title:(0,g.t)("Calculated columns")}),children:(0,W.Y)(ge,{children:(0,W.Y)(Ae,{columns:this.state.calculatedColumns,onColumnsChange:e=>this.setColumns({calculatedColumns:e}),columnLabelTooltips:{column_name:(0,g.t)("This field is used as a unique identifier to attach the calculated dimension to charts. It is also used as the alias in the SQL query.")},onDatasourceChange:this.onDatasourceChange,datasource:e,editableColumnName:!0,showExpression:!0,allowAddItem:!0,allowEditDataType:!0,itemGenerator:()=>({column_name:(0,g.t)("<new column>"),filterable:!0,groupby:!0,expression:(0,g.t)("<enter SQL expression here>"),__expanded:!0})})})},3),(0,W.Y)(S.Ay.TabPane,{tab:(0,g.t)("Settings"),children:(0,W.FD)(Y.fI,{gutter:16,children:[(0,W.Y)(Y.fv,{xs:24,md:12,children:(0,W.Y)(Se,{children:this.renderSettingsFieldset()})}),(0,W.Y)(Y.fv,{xs:24,md:12,children:(0,W.Y)(Se,{children:this.renderAdvancedFieldset()})})]})},4)]})]})}componentDidMount(){Q().bind("ctrl+shift+f",(e=>(e.preventDefault(),this.state.isEditMode&&this.onQueryFormat(),!1)))}componentWillUnmount(){Q().unbind("ctrl+shift+f"),this.props.resetQuery()}}ke.defaultProps={onChange:()=>{},setIsEditing:()=>{}},ke.propTypes=De;const Fe=(0,v.b)(ke),Le=(0,$.Ay)((0,U.Ng)((e=>({database:null==e?void 0:e.database})),(e=>({runQuery:t=>e(function(e){return async function(t){try{t(P(!0)),t({type:"SET_QUERY_RESULT",payload:await R(e)})}catch(e){t(function(e){return{type:"SET_QUERY_ERROR",payload:e}}(e.message))}finally{t(P(!1))}}}(t)),resetQuery:()=>e({type:"RESET_DATABASE_STATE"}),formatQuery:t=>e(function(e){return function(t){return b.A.post({endpoint:"/api/v1/sqllab/format_sql/",body:JSON.stringify({sql:e}),headers:{"Content-Type":"application/json"}}).then((e=>(t({type:"SET_QUERY",payload:e.json.result}),e)))}}(t))})))(Fe))},19855:(e,t,a)=>{a.d(t,{A:()=>f});var n=a(96540),i=a(5556),s=a.n(i),o=a(90868),r=a(8700),l=a(19129),d=a(78518),c=a(98837),h=a(46920),p=a(24976),u=a(18301),m=a(50317),g=a(2445);const y={name:s().string,onChange:s().func,initialValue:s().string,height:s().number,minLines:s().number,maxLines:s().number,offerEditInModal:s().bool,language:s().oneOf([null,"json","html","sql","markdown","javascript"]),aboveEditorSection:s().node,readOnly:s().bool,resize:s().oneOf([null,"block","both","horizontal","inline","none","vertical"]),textAreaStyles:s().object,tooltipOptions:s().oneOf([null,r.TooltipProps]),hotkeys:s().array};class b extends n.Component{onControlChange(e){const{value:t}=e.target;this.props.onChange(t)}onAreaEditorChange(e){this.props.onChange(e)}renderEditor(e=!1){const t=e?40:this.props.minLines||12;if(this.props.language){const a={border:`1px solid ${this.props.theme.colors.grayscale.light1}`,minHeight:`${t}em`,width:"auto",...this.props.textAreaStyles};this.props.resize&&(a.resize=this.props.resize),this.props.readOnly&&(a.backgroundColor="#f2f2f2");const n=e=>{this.props.hotkeys.forEach((t=>{e.commands.addCommand({name:t.name,bindKey:{win:t.key,mac:t.key},exec:t.func})}))},i=(0,g.Y)("div",{children:(0,g.Y)(p.S9,{mode:this.props.language,style:a,minLines:t,maxLines:e?1e3:this.props.maxLines,editorProps:{$blockScrolling:!0},onLoad:n,defaultValue:this.props.initialValue,readOnly:this.props.readOnly,...this.props,onChange:this.onAreaEditorChange.bind(this)},this.props.name)});return this.props.tooltipOptions?(0,g.Y)(l.m_,{...this.props.tooltipOptions,children:i}):i}const a=(0,g.Y)("div",{children:(0,g.Y)(o.fs,{placeholder:(0,d.t)("textarea"),onChange:this.onControlChange.bind(this),defaultValue:this.props.initialValue,disabled:this.props.readOnly,style:{height:this.props.height},"aria-required":this.props["aria-required"]})});return this.props.tooltipOptions?(0,g.Y)(l.m_,{...this.props.tooltipOptions,children:a}):a}renderModalBody(){return(0,g.FD)(g.FK,{children:[(0,g.Y)("div",{children:this.props.aboveEditorSection}),this.renderEditor(!0)]})}render(){const e=(0,g.Y)(m.A,{...this.props});return(0,g.FD)("div",{children:[e,this.renderEditor(),this.props.offerEditInModal&&(0,g.Y)(u.A,{modalTitle:e,triggerNode:(0,g.FD)(h.A,{buttonSize:"small",className:"m-t-5",children:[(0,d.t)("Edit")," ",(0,g.Y)("strong",{children:this.props.language})," ",(0,d.t)("in modal")]}),modalBody:this.renderModalBody(!0),responsive:!0})]})}}b.propTypes=y,b.defaultProps={onChange:()=>{},initialValue:"",height:250,minLines:3,maxLines:10,offerEditInModal:!0,readOnly:!1,resize:null,textAreaStyles:{},tooltipOptions:{},hotkeys:[]};const f=(0,c.b)(b)},46022:(e,t,a)=>{a.d(t,{A:()=>m});var n=a(96540),i=a(71519),s=a(46942),o=a.n(s),r=a(96453),l=a(78518),d=a(17437),c=a(19129),h=a(58132),p=a(2445);const u=(0,r.I4)(h.A)`
  vertical-align: middle;
`;function m({canEdit:e=!1,editing:t=!1,extraClasses:a,multiLine:s=!1,noPermitTooltip:r,onSaveTitle:h,showTooltip:m=!0,style:g,title:y="",defaultTitle:b="",placeholder:f="",certifiedBy:C,certificationDetails:_,url:v,...Y}){const[A,x]=(0,n.useState)(t),[S,D]=(0,n.useState)(y),[w,E]=(0,n.useState)(y),[T,I]=(0,n.useState)(null),k=(0,n.useRef)();function F(){if(!e||A)return;const t=k.current?k.current.getBoundingClientRect():null;x(!0),I(t)}function L(){const t=S.trim();e&&(x(!1),t.length?(w!==t&&E(t),y!==t&&h(t)):D(w))}function q(e){" "===e.key&&e.stopPropagation(),"Enter"===e.key&&(e.preventDefault(),L())}function M(t){e&&D(t.target.value)}function O(e){"Enter"===e.key&&(e.preventDefault(),L())}let $;(0,n.useEffect)((()=>{y!==S&&(E(S),D(y))}),[y]),(0,n.useEffect)((()=>{if(A&&(k.current.focus(),k.current.setSelectionRange)){const{length:e}=k.current.value;k.current.setSelectionRange(e,e),k.current.scrollLeft=k.current.scrollWidth,k.current.scrollTop=k.current.scrollHeight}}),[A]),$=S,A||S||($=b||y);const z=A&&T?{height:`${T.height}px`}:void 0;let K=s&&A?(0,p.Y)("textarea",{"data-test":"editable-title-input",ref:k,value:$,className:y?void 0:"text-muted",onKeyDown:q,onChange:M,onBlur:L,onClick:F,onKeyPress:O,placeholder:f,style:z}):(0,p.Y)("input",{"data-test":"editable-title-input",ref:k,type:A?"text":"button",value:$,className:y?void 0:"text-muted",onKeyDown:q,onChange:M,onBlur:L,onClick:F,onKeyPress:O,placeholder:f});return m&&!A&&(K=(0,p.Y)(c.m_,{id:"title-tooltip",title:e?(0,l.t)("Click to edit"):r||(0,l.t)("You don't have the rights to alter this title."),children:K})),e||(K=v?(0,p.Y)(i.N_,{to:v,"data-test":"editable-title-input",css:e=>d.AH`
          color: ${e.colors.grayscale.dark1};
          text-decoration: none;
          :hover {
            text-decoration: underline;
          }
          display: inline-block;
        `,children:$}):(0,p.Y)("span",{"data-test":"editable-title-input",children:$})),(0,p.FD)("span",{"data-test":"editable-title",className:o()("editable-title",a,e&&"editable-title--editable",A&&"editable-title--editing"),style:g,...Y,children:[C&&(0,p.FD)(p.FK,{children:[(0,p.Y)(u,{certifiedBy:C,details:_,size:"xl"})," "]}),K]})}},64535:(e,t,a)=>{a.d(t,{A:()=>s});var n=a(66265),i=a(2445);const s=e=>(0,i.Y)(n.A,{...e})}}]);