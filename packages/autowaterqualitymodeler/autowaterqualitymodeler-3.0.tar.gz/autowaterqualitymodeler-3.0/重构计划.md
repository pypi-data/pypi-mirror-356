# AutoWaterQualityModeler 重构计划

## 新项目结构

```
autowaterqualitymodeler/
│
├── __init__.py               # 包初始化
├── _version.py               # 版本控制
│
├── core/                     # 核心组件
│   ├── __init__.py
│   ├── modeler.py            # 重构后的建模器（核心API）
│   ├── feature_manager.py    # 特征管理
│   └── config_manager.py     # 配置管理
│
├── preprocessing/            # 数据预处理
│   ├── __init__.py
│   ├── spectrum_processor.py # 光谱数据预处理
│   └── filters.py            # 滤波器和平滑算法
│
├── features/                 # 特征计算
│   ├── __init__.py
│   ├── calculator.py         # 特征计算器（重构自spectral_calculator）
│   ├── functions.py          # 特征计算函数
│   └── validators.py         # 特征定义验证
│
├── models/                   # 模型构建
│   ├── __init__.py
│   ├── builder.py            # 模型构建器
│   ├── fitter.py             # 拟合算法
│   ├── tuner.py              # 模型微调
│   └── evaluator.py          # 模型评估
│
├── utils/                    # 工具函数
│   ├── __init__.py
│   ├── logger.py             # 日志工具
│   ├── encryption.py         # 加密工具
│   └── validators.py         # 输入验证
│
├── config/                   # 配置文件
│   ├── __init__.py
│   └── features_config.json  # 特征配置
│
├── resources/                # 资源文件
│   ├── D65xCIE.xlsx          # 三刺激值系数
│   └── CIE_README.txt        # 说明文档
│
└── cli/                      # 命令行接口
    ├── __init__.py
    └── commands.py           # 命令行工具
```

## 重构步骤

1. **创建新的目录结构**
   - 按照上述结构创建目录和文件

2. **核心组件重构**
   - 将`modeler.py`拆分为多个职责单一的类
   - 实现`ConfigManager`类管理配置文件
   - 实现`FeatureManager`类管理特征定义

3. **预处理模块重构**
   - 将数据预处理功能从`modeler.py`提取到`SpectrumProcessor`类
   - 实现各种滤波器和平滑算法

4. **特征计算模块重构**
   - 重构`SpectralCalculator`类，使其更加模块化
   - 将公式解析和计算分离

5. **模型构建模块重构**
   - 实现`ModelBuilder`类处理模型构建逻辑
   - 实现`ModelTuner`类处理模型微调逻辑
   - 实现`ModelEvaluator`类处理模型评估

6. **工具函数重构**
   - 完善日志工具
   - 优化加密工具
   - 添加输入验证

7. **命令行接口重构**
   - 实现更友好的命令行接口

## 类设计

### 核心模块

```python
class AutoWaterQualityModeler:
    """水质建模器主类，对外提供API"""
    
    def __init__(self, config_path=None):
        self.config_manager = ConfigManager(config_path)
        self.feature_manager = FeatureManager(self.config_manager)
        self.processor = SpectrumProcessor()
        self.model_builder = ModelBuilder()
        
    def fit(self, spectrum_data, metric_data, data_type="aerospot"):
        """一键式建模流程"""
        
    def predict(self, spectrum_data, model_data):
        """预测水质参数"""
        
    def save_model(self, model_data, output_path=None):
        """保存模型"""
        
    def load_model(self, model_path):
        """加载模型"""
```

### 配置管理

```python
class ConfigManager:
    """配置管理器，处理特征配置文件加载和访问"""
    
    def __init__(self, config_path=None):
        self.config = self._load_config(config_path)
        
    def get_feature_definitions(self, data_type, metric):
        """获取特征定义"""
        
    def get_model_params(self, data_type=None, metric=None):
        """获取模型参数"""
```

### 特征管理

```python
class FeatureManager:
    """特征管理器，处理特征定义和计算"""
    
    def __init__(self, config_manager):
        self.config_manager = config_manager
        self.calculator = FeatureCalculator()
        
    def calculate_features(self, spectrum_data, data_type, metric):
        """计算指定指标的特征"""
```

### 数据预处理

```python
class SpectrumProcessor:
    """光谱数据预处理器"""
    
    def preprocess(self, spectrum_data, min_wavelength=400, max_wavelength=900, 
                  smooth_window=11, smooth_order=3):
        """预处理光谱数据"""
        
    def resample(self, spectrum_data):
        """重采样光谱数据"""
        
    def smooth(self, spectrum_data, window=11, order=3):
        """平滑光谱数据"""
        
    def filter_anomalies(self, spectrum_data, threshold=0.1):
        """过滤异常值"""
```

### 特征计算

```python
class FeatureCalculator:
    """特征计算器，用于计算光谱特征"""
    
    def __init__(self, tris_coeff=None):
        self.tris_coeff = tris_coeff
        self.functions = self._register_functions()
        
    def evaluate(self, expression, data):
        """解析并计算表达式"""
        
    def _register_functions(self):
        """注册支持的函数"""
```

### 模型构建

```python
class ModelBuilder:
    """模型构建器，处理模型拟合和评估"""
    
    def build(self, features, target, model_params=None):
        """构建模型"""
        
    def tune(self, predicted, measured):
        """微调现有模型"""
        
    def evaluate(self, model, features, target):
        """评估模型性能"""
```

## 使用示例

```python
# 创建建模器
modeler = AutoWaterQualityModeler()

# 加载数据
spectrum_data = pd.read_csv("spectrum.csv")
metric_data = pd.read_csv("metrics.csv")

# 建模
model, pred, all_pred = modeler.fit(
    spectrum_data=spectrum_data,
    metric_data=metric_data,
    data_type="aerospot"
)

# 保存模型
model_path = modeler.save_model(model)

# 加载模型并预测
loaded_model = modeler.load_model(model_path)
predictions = modeler.predict(spectrum_data, loaded_model)
``` 