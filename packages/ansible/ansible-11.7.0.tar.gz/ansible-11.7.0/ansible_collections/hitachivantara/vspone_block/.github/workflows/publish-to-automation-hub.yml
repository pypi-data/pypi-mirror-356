name: Publish to Automation Hub

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag version to publish (e.g. v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: read

jobs:
  publish_automation_hub:
    name: Publish to Red Hat Automation Hub
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: pip install ansible-core --disable-pip-version-check

      - name: Build Ansible Collection
        run: |
          ansible-galaxy collection build --force
          echo "✅ Collection build completed."

      - name: Find Collection File
        id: find-collection
        run: |
          COLLECTION_FILE=$(ls *.tar.gz | head -n 1)
          if [[ -z "$COLLECTION_FILE" ]]; then
            echo "❌ No collection file found! Exiting."
            exit 1
          fi
          echo "✅ Found collection file: $COLLECTION_FILE"
          echo "COLLECTION_FILE=$COLLECTION_FILE" >> $GITHUB_ENV

      - name: Configure Ansible for Automation Hub
        run: |
          mkdir -p ~/.ansible
          cat > ~/.ansible/ansible.cfg <<EOF
            [galaxy]
            server_list = automation_hub

            [galaxy_server.automation_hub]
            url=https://console.redhat.com/api/automation-hub/
            auth_url=https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token
            token=${{ secrets.AUTOMATION_HUB_TOKEN }}
            EOF
          echo "✅ ansible.cfg configured for Automation Hub."

      - name: Publish to Automation Hub
        run: |
          echo "🚀 Publishing to Automation Hub..."
          ansible-galaxy collection publish "$COLLECTION_FILE"
          echo "✅ Successfully published to Automation Hub."
