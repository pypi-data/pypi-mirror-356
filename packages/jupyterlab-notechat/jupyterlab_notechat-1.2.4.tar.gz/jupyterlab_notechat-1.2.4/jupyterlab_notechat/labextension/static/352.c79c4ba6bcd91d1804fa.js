"use strict";(self.webpackChunkjupyterlab_notechat=self.webpackChunkjupyterlab_notechat||[]).push([[352],{352:(e,t,o)=>{o.r(t),o.d(t,{default:()=>Y});var n=o(542),a=o(560),s=o(689),i=o(88),l=o(186);const r={plugin_id:"jupyterlab-notechat:plugin",ai_name:"**assistant**",user_name:"**user**",cell_param_name_refs:"refs",ref_name:"_ref",num_prev_cells:80,data_types:["text/plain","image/png","image/jpeg","image/gif","image/webp"]},c={prompt:"You are a helpful and warm-hearted assistant:) You have a good background knowledge in AI, STEM, finance, economics, statistics and related fields. Now you are helping the user to develop code, analyze data or write a report under a JupyterLab notebook environment (format: *.ipynb). If the user does not provide explicit questions, you can try to solve problems presented in the context and elaborate further on relevant topics.",model:"gemini-2.5-pro-preview-06-05",vision_model:"gemini-2.5-pro-preview-06-05",use_vision:!0,max_input:16e4,max_output:0,temperature:-1,response_format:"text",timeout:200,retries:2,delay:.5,llm_api_key:"None"};let d="",m="",h="",u="",p="",g="",f="",b="",v="",w="",y="",x="",C="";(navigator.language||"en").startsWith("zh")?(d='<a href="https://github.com/firezym/jupyterlab-notechat" target="_blank" style="background-color: yellow; font-weight: bold; font-size: 16px; color: blue; text-decoration: underline;"> NoteChat 帮助 || 点击前往GitHub项目页面（更易读）</a> <br><br> Notechat工具初衷是让用户有更精准可控的对话，包括不仅局限于精确指定上下文引用、修改AI生成的文本作为上下文、在程序中直接引用用户和AI生成的文本等等，使得用户更好利用LLM的长处，所以除了常见的对话外（虽然使用体验不及对话流），还可以辅助书写结构化的中长篇报告、文本对比分析、获取和沉淀知识、辅助编程创建分析模型等任务。 <br><br>',m="1. 创建用户消息：直接新建单元格输入你的问题，或使用`Add a User Chat Cell`指令或点击对应的菜单或单元格按钮添加一个以**user**形式开头的markdown单元格，能够更明确这是用户创建的一个对话消息 <br><br>",h="2. 参数设定：在cell的第一行中添加以`@参数 xxx`形式的自定义参数赋值，但请勿在其中使用转义换行符，主要参数及示例如下： <br>",u="【@refs】 指定当前单元格和AI对话所引用的其他单元格，使得上下文更加精准，比如书写长报告过程中，每个章节只需要看到一开始拟定的提纲，而无需看到其他小节的内容，以下示例的除指定范围引用和alone模式外，引用的赋值一般以并集形式叠加，举例： <br> @refs -8, +2，2 be73e0fc-6e1c-4d49-a288-94e3f7ec8215 # 将引用当前消息之前的第8个、之后的第2个、从0开始正数第2个以及唯一id为“be...15”的单元格，分隔符可以是,，|；; ，如果指定的id中没有含有中英文冒号:：及~类型的范围引用，则还会附加默认参数中指定数量的上下文，可在settings中更改 # <br> @refs alone -8, +2 # 如果指定了alone、single、和sole的字样，则代表忽略默认附加的范围引用，仅使用当前单元格中指定的单个或范围引用，如果仅有alone则代表只看当前单元格 # <br> @refs -10:0 # 引用当前消息之前的8个单元格内容，[]中英文方括号可加可不加 # <br> @refs :+2 ‘xxxxxx’ # 引用文档起始至当前单元格下方第2个单元格之前的所有内容以及唯一id为xxxxxx的单元格 # <br> @refs 【2:8】 # 如果范围未带任何+-号，则代表是文档的绝对id顺序中的第2个到第8个 #  <br>",p="【@files file_path/file_name】 可以进行跨多个文件全文引用，请避免包含空格等容易产生混淆的字符，`@`字符已经过特殊处理路径中可包含，目前支持的类型包括文本类txt/md/py/js/ts/sh/bat/json/xml/log/config/ini/yaml/yml、表格类csv/xlsx/xls、文档类pdf/docx/pptx/html/htm，其中出了ipynb文件可以包含图片，其他文件解析尚未包含图片 <br>",g="【@num_prev_cells 8】 在当前单元格对话中覆盖系统设定的向前引用范围至8 <br>",f="【@prompt xyz】 用xyz替换系统默认的prompt提示词，请勿使用换行符 <br> 【@add_prompt xyz】 将xyz添加到系统默认的prompt后组合成为新的提示词 <br>",b="【@model o1】 指定具体的模型，默认模型为gemini-2.5-pro-preview-06-05 <br> 【@use_vison false】 不使用图片视觉模型，默认使用true，可以在markdown单元格中直接粘贴截图或图片，但图片地址目前不支持 <br>【@max_input/@max_output 888】 设定input和output最大的token数量，这里超过max_input就会按照绝对id的原始顺序截断，但prompt和当前单元格优先保留，但图片tokens数量目前未支持计入 <br> 【@temperature 0.5】 0~1直接设定LLM模型生成的随机性 <br> 【@timeout 600】 设定模型最长响应时间 <br>",v='【单个notebook级别参数设定】 如果要保证可复现性，可以在notebook右上角的Property Inspector（齿轮图标）-> ADVANCED TOOLS -> Notebook metadata 中，加入`"notechat":{"param":value}`来覆盖参数，比如设定notebook级别的prompt，注意这里的param不用加@，覆盖优先级为user>assistant>notebook>settings <br><br>',w="3. 表格识别：目前没有很好的处理html的工具，推荐使用pandas处理数据，并尽量用df.to_markdown()转化成为markdown表格格式，LLM能更好处理识别 <br><br>",y="4. 支持从上到下顺序运行python code cell和LLM支持的user及assistant的对话流：方便长流程工作，比如自动化更新带数据带LLM总结分析的报告 <br><br>",x='5. 程序文本和LLM文本交互：markdown单元格和code单元格的source文本，都可以在当前kernel程序中直接按照_refs["唯一id"]形式引用，方便用户利用python和LLM之间做文本交互输入输出 <br><br>',C="6. Info、Help按键和指令：获得当前单元格xxxxxx字符串形式的唯一id以及从0开始计数的绝对id，当前单元格所要引用的id，@param的个性化参数等信息，其中点击时，当前单元格的唯一id引用将会拷贝到粘贴板中方便用户引用，跨notebook的请直接用python程序按照json数据读取.ipynb文件，从中找到唯一id所对应的单元格信息 <br><br>"):(d='<a href="https://github.com/firezym/jupyterlab-notechat" target="_blank" style="background-color: yellow; font-weight: bold; font-size: 16px; color: blue; text-decoration: underline;"> NoteChat Help || Go to GitHub Repo (Easier to Read) </a> <br><br> The original intention of the NoteChat tool is to allow users to have more precise and controllable conversations, including but not limited to precisely specifying context references, modifying AI-generated text as context, directly referencing python cell code/outputs and AI-generated texts in the program reciprocally, etc., so that users can better utilize the strengths of LLMs. Therefore, besides common conversations (although the user experience is not as good as dialogue flow), it can also assist in text manipulation of LLM dialogue flow within markdown or code cells, writing structured essay or long reports, data and text analysis with LLM models, assisting programming, acquiring LLM knowledge to notebookand, and other tasks. <br><br>',m="1. Create a user message: Directly create a new cell to input your question, or use the `Add a User Chat Cell` command, or click the corresponding menu or cell button to add a markdown cell starting with **user**, which can more clearly indicate that this is a dialogue message created by the user. <br><br>",h="2. Parameter settings: Add custom parameter assignments in the form of `@parameter xxx` on the first line of the cell, but do not use escaped newline characters in it. The main parameters and examples are as follows: <br>",u='【@refs】 Specify other cells that the current cell and AI conversation refer to, making the context more precise. For example, during the writing of a long report, each chapter only needs to see the initial outline, without needing to see the content of other sections. In the following examples, except for specified range references and the "alone" mode, the references are generally overlaid in a union. For example: <br> @refs -8, +2, 2 be73e0fc-6e1c-4d49-a288-94e3f7ec8215 # Will reference the 8th cell before the current message, the 2nd cell after it, the 2nd cell counting from zero, and the cell with unique ID "be...15". The separators can be ,, | ; ;. If the specified IDs do not contain range references of colon : or ~ type, the default number of context specified in settings will also be added. # <br> @refs alone -8, +2 # If words like alone, single, and sole are specified, it means ignoring the default additional range references and only using the single or range references specified in the current cell. If only "alone" is present, it means only looking at the current cell. # <br> @refs -10:0 # Reference the contents of the 8 cells before the current message. Reference the contents of the 8 cells before the current message. [] brackets around the range can be added optionally such as @refs [-10:0] for better readability. # <br> @refs :+2 \'xxxxxx\' # Reference all content from the beginning of the document up to the second cell below the current cell, as well as the cell with unique ID \'xxxxxx\'. # <br> @refs 【2:8】 # If the range does not have any + or -, it represents the 2nd to the 8th cells in the absolute ID order of the document. # <br>',p="【@files file_path/file_name】 Can perform full-text references across multiple files. Please avoid characters like spaces that can easily cause confusion. The `@` character has been specially processed and can be included in the path. Currently supported types include text types like txt/md/py/js/ts/sh/bat/json/xml/log/config/ini/yaml/yml, spreadsheet types like csv/xlsx/xls, document types like pdf/docx/pptx/html/htm. Among these, except for ipynb files which can include images, other file parsing does not yet include images. <br>",g="【@num_prev_cells 8】 In the current cell's conversation, override the system's default forward reference range to 8. <br>",f="【@prompt xyz】 Use xyz to replace the system's default prompt; please do not use newline characters. <br> 【@add_prompt xyz】 Add xyz to the system's default prompt to form a new prompt. <br>",b="【@model o1】choose model based on your needs, default to gemini-2.5-pro-preview-06-05 <br> 【@use_vision false】 Do not use the image vision model; the default is true. You can directly paste screenshots or images into markdown cells, but image URLs are not currently supported. <br>【@max_input/@max_output 888】 Set the maximum token number of input and output. If it exceeds max_input here, it will be truncated according to the original order of absolute IDs, but the prompt and current cell are preferentially retained. Currently, the token count of images is not yet supported. <br> 【@temperature 0.5】 Set the randomness of the LLM model directly between 0~1. <br> 【@timeout 600】 Set the maximum response time of the model. <br>",v='【Single notebook-level parameter settings】 To ensure reproducibility, you can add `"notechat":{"param":value}` in the Notebook metadata via the Property Inspector (gear icon) in the top right corner of the notebook under ADVANCED TOOLS to override parameters, such as setting the notebook-level prompt. Note that the param here does not need to add @. The override priority is user > assistant > notebook > settings. <br><br>',w="3. Table recognition: Currently, there are no good tools to handle HTML. It is recommended to use pandas to process data and try to convert it into markdown table format using df.to_markdown(), which LLM can better recognize and process. <br><br>",y="4. Supports running python code cells and LLM-supported user and assistant dialogue flows in sequence from top to bottom: Convenient for long-process work, such as automatically updating reports with data and LLM summary analysis. <br><br>",x='5. Interaction between python kernel and LLM messages: The source text of markdown cells and code cells can be directly referenced in the current kernel program in the form of _refs["unique id"], facilitating users to perform text input and output interactions between python kernel and LLM messages. <br><br>',C="6. Info, help buttons and commands: Obtain the unique id of the current cell in the form of a string xxxxxx and the absolute id counting from 0, the ids that the current cell wants to reference, personalized parameters of @param, and other information. When clicked, the unique id reference of the current cell will be copied to the clipboard for user reference. For cross-notebook use, please directly use a Python program to read the .ipynb file as JSON data to find the cell information corresponding to the unique id. <br><br>");const _=`${d}${m}${h}${u}${p}${g}${f}${b}${v}${w}${y}${x}${C}`,k=async(e,t,o=2e3)=>{let n=null;const a=()=>{null!==n&&clearTimeout(n),n=window.setTimeout(i,o)},s=()=>{null!==n&&(clearTimeout(n),n=null)},i=()=>{s(),l.removeEventListener("mouseenter",s),l.removeEventListener("mouseleave",a),document.body.contains(l)&&document.body.removeChild(l)},l=document.createElement("div");l.className="notification",l.innerHTML=e;const r=t.toolbar.node.getBoundingClientRect();l.style.top=`${r.bottom}px`;const c=document.createElement("button");c.textContent="✖",c.className="notification-close",c.addEventListener("click",i),l.appendChild(c),document.body.appendChild(l),l.addEventListener("mouseenter",s),l.addEventListener("mouseleave",a),a()},I=e=>{const t=(new TextEncoder).encode(e);return btoa(String.fromCharCode.apply(null,Array.from(t)))},L=async(e,t=[],o=[])=>{let n=e.split("\n");return n.length>0&&t.some(e=>n[0].includes(e))&&(n=n.slice(1)),n.length>0&&o.some(e=>n[n.length-1].includes(e))&&(n=n.slice(0,-1)),n.join("\n").trim()},A=async e=>{const t={},o="<AT>",n=e.trim().replace(/\S+?\.\S+/g,e=>e.includes(".")&&e.includes("@")?e.replace(/@/g,o):e).trim().match(/@(\w+)\s([^@]*)/g);return n&&n.forEach(e=>{const n=e.trim().split(/\s+/),a=n[0].replace(/^@/,"");1===n.length?t[a]="":t[a]=n.slice(1).join(" ").replace(new RegExp(o,"g"),"@")}),t},N=async(e,t,o,n=2)=>{if(!e){const e=[];for(let o=Math.max(0,t-Math.abs(n));o<=t;o++)e.push(o);return e}const a=e.replace(/^\s*[\[\]【】{}()（）]\s*|\s*[\[\]【】{}()（）]\s*$/g,"").split(/[,，|；; ]+/),s=new Set;s.add(t);let i=!1;if(a.forEach(e=>{if(e.match(/['"“”‘’`]/)){const t=e.replace(/['"“”‘’`]/g,"").trim();t&&s.add(t)}else if(e.match(/^[-+]\d+$/)){const o=parseInt(e,10),n=t+o;s.add(n)}else if(e.match(/^\d+$/)){const t=parseInt(e,10);s.add(t)}else if(e.match(/^(alone|single|sole)$/))i=!0,s.add(t);else if(e.match(/^[:：~]+$/)){i=!0;for(let e=0;e<=o;e++)s.add(e)}else if(e.match(/^(\++0*[:：~]+|[:：~]+\++0*|\++[:：~]+0+|0+[:：~]+\++)$/)){i=!0;for(let e=t;e<=o;e++)s.add(e)}else if(e.match(/^(\-+0*[:：~]+|[:：~]+\-+0*|\-+[:：~]+0+|0+[:：~]+\-+)$/)){i=!0;for(let e=0;e<=t;e++)s.add(e)}else if(e.match(/^[-+]\d+[:：~]$/)){i=!0;const[n]=e.split(/[:：~]/),a=n?parseInt(n,10):0;for(let e=Math.max(0,t+a);e<=o;e++)s.add(e)}else if(e.match(/^\d+[:：~]$/)){i=!0;const[t]=e.split(/[:：~]/),n=t?parseInt(t,10):0;for(let e=Math.max(0,n);e<=o;e++)s.add(e)}else if(e.match(/^[:：~][-+]\d+$/)){i=!0;const[,n]=e.split(/[:：~]/),a=n?parseInt(n,10):0,l=Math.min(t+a,o);for(let e=0;e<=l;e++)s.add(e)}else if(e.match(/^[:：~]\d+$/)){i=!0;const[,t]=e.split(/[:：~]/),n=t?parseInt(t,10):0,a=Math.min(n,o);for(let e=0;e<=a;e++)s.add(e)}else if(e.match(/^([-+]\d+[:：~]\d+|\d+[:：~][-+]\d+|[-+]\d+[:：~][-+]\d+)$/)){i=!0;const[n,a]=e.split(/[:：~]/),l=n?parseInt(n,10):0,r=a?parseInt(a,10):0,c=Math.min(t+l,t+r),d=Math.max(t+l,t+r);for(let e=Math.max(0,c);e<=Math.min(d,o);e++)s.add(e)}else if(e.match(/^(\d+[:：~]\d*|\d*[:：~]\d+)$/)){i=!0;const[t,n]=e.split(/[:：~]/),a=t?parseInt(t,10):0,l=n?parseInt(n,10):0,r=Math.min(a,l),c=Math.max(a,l);for(let e=Math.max(0,r);e<=Math.min(c,o);e++)s.add(e)}else e.trim()&&s.add(e.trim())}),!1===i)for(let e=Math.max(0,t-Math.abs(n));e<=t;e++)s.add(e);return Array.from(s).sort((e,t)=>"number"==typeof e&&"number"==typeof t?e-t:"string"==typeof e&&"string"==typeof t?e.localeCompare(t):"number"==typeof e?-1:1)};var M=o(484);const $=new M.LabIcon({name:"jupyterlab-notechat:atom-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">\x3c!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2023 Fonticons, Inc.--\x3e<path class="notechat-color" d="M256 398.8c-11.8 5.1-23.4 9.7-34.9 13.5c16.7 33.8 31 35.7 34.9 35.7s18.1-1.9 34.9-35.7c-11.4-3.9-23.1-8.4-34.9-13.5zM446 256c33 45.2 44.3 90.9 23.6 128c-20.2 36.3-62.5 49.3-115.2 43.2c-22 52.1-55.6 84.8-98.4 84.8s-76.4-32.7-98.4-84.8c-52.7 6.1-95-6.8-115.2-43.2C21.7 346.9 33 301.2 66 256c-33-45.2-44.3-90.9-23.6-128c20.2-36.3 62.5-49.3 115.2-43.2C179.6 32.7 213.2 0 256 0s76.4 32.7 98.4 84.8c52.7-6.1 95 6.8 115.2 43.2c20.7 37.1 9.4 82.8-23.6 128zm-65.8 67.4c-1.7 14.2-3.9 28-6.7 41.2c31.8 1.4 38.6-8.7 40.2-11.7c2.3-4.2 7-17.9-11.9-48.1c-6.8 6.3-14 12.5-21.6 18.6zm-6.7-175.9c2.8 13.1 5 26.9 6.7 41.2c7.6 6.1 14.8 12.3 21.6 18.6c18.9-30.2 14.2-44 11.9-48.1c-1.6-2.9-8.4-13-40.2-11.7zM290.9 99.7C274.1 65.9 259.9 64 256 64s-18.1 1.9-34.9 35.7c11.4 3.9 23.1 8.4 34.9 13.5c11.8-5.1 23.4-9.7 34.9-13.5zm-159 88.9c1.7-14.3 3.9-28 6.7-41.2c-31.8-1.4-38.6 8.7-40.2 11.7c-2.3 4.2-7 17.9 11.9 48.1c6.8-6.3 14-12.5 21.6-18.6zM110.2 304.8C91.4 335 96 348.7 98.3 352.9c1.6 2.9 8.4 13 40.2 11.7c-2.8-13.1-5-26.9-6.7-41.2c-7.6-6.1-14.8-12.3-21.6-18.6zM336 256a80 80 0 1 0 -160 0 80 80 0 1 0 160 0zm-80-32a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg>'}),S=new M.LabIcon({name:"jupyterlab-notechat:info-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">\x3c!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2023 Fonticons, Inc.--\x3e<path class="notechat-color" d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg>'}),z=new M.LabIcon({name:"jupyterlab-notechat:all-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">\x3c!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2023 Fonticons, Inc.--\x3e<path class="notechat-color" d="M403.8 34.4c12-5 25.7-2.2 34.9 6.9l64 64c6 6 9.4 14.1 9.4 22.6s-3.4 16.6-9.4 22.6l-64 64c-9.2 9.2-22.9 11.9-34.9 6.9s-19.8-16.6-19.8-29.6V160H352c-10.1 0-19.6 4.7-25.6 12.8L284 229.3 244 176l31.2-41.6C293.3 110.2 321.8 96 352 96h32V64c0-12.9 7.8-24.6 19.8-29.6zM164 282.7L204 336l-31.2 41.6C154.7 401.8 126.2 416 96 416H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H96c10.1 0 19.6-4.7 25.6-12.8L164 282.7zm274.6 188c-9.2 9.2-22.9 11.9-34.9 6.9s-19.8-16.6-19.8-29.6V416H352c-30.2 0-58.7-14.2-76.8-38.4L121.6 172.8c-6-8.1-15.5-12.8-25.6-12.8H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H96c30.2 0 58.7 14.2 76.8 38.4L326.4 339.2c6 8.1 15.5 12.8 25.6 12.8h32V320c0-12.9 7.8-24.6 19.8-29.6s25.7-2.2 34.9 6.9l64 64c6 6 9.4 14.1 9.4 22.6s-3.4 16.6-9.4 22.6l-64 64z"/></svg>'}),j=new M.LabIcon({name:"jupyterlab-notechat:above-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="16" width="18" viewBox="0 0 576 512">\x3c!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2023 Fonticons, Inc.--\x3e<path class="notechat-color" d="M32 96l512 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32C14.3 32 0 46.3 0 64S14.3 96 32 96zM9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L96 237.3 96 448c0 17.7 14.3 32 32 32s32-14.3 32-32l0-210.7 41.4 41.4c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3l-96-96c-12.5-12.5-32.8-12.5-45.3 0l-96 96zm320 45.3c12.5 12.5 32.8 12.5 45.3 0L416 237.3 416 448c0 17.7 14.3 32 32 32s32-14.3 32-32l0-210.7 41.4 41.4c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3l-96-96c-12.5-12.5-32.8-12.5-45.3 0l-96 96c-12.5 12.5-12.5 32.8 0 45.3z"/></svg>'}),T=new M.LabIcon({name:"jupyterlab-notechat:below-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="16" width="18" viewBox="0 0 576 512">\x3c!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2023 Fonticons, Inc.--\x3e<path class="notechat-color" d="M544 416L32 416c-17.7 0-32 14.3-32 32s14.3 32 32 32l512 0c17.7 0 32-14.3 32-32s-14.3-32-32-32zm22.6-137.4c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L480 274.7 480 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 210.7-41.4-41.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l96 96c12.5 12.5 32.8 12.5 45.3 0l96-96zm-320-45.3c-12.5-12.5-32.8-12.5-45.3 0L160 274.7 160 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 210.7L54.6 233.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l96 96c12.5 12.5 32.8 12.5 45.3 0l96-96c12.5-12.5 12.5-32.8 0-45.3z"/></svg>'}),O=new M.LabIcon({name:"jupyterlab-notechat:selected-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="16" width="18" viewBox="0 0 576 512">\x3c!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2023 Fonticons, Inc.--\x3e<path class="notechat-color" d="M151.6 469.6C145.5 476.2 137 480 128 480s-17.5-3.8-23.6-10.4l-88-96c-11.9-13-11.1-33.3 2-45.2s33.3-11.1 45.2 2L96 365.7V64c0-17.7 14.3-32 32-32s32 14.3 32 32V365.7l32.4-35.4c11.9-13 32.2-13.9 45.2-2s13.9 32.2 2 45.2l-88 96zM320 32h32c17.7 0 32 14.3 32 32s-14.3 32-32 32H320c-17.7 0-32-14.3-32-32s14.3-32 32-32zm0 128h96c17.7 0 32 14.3 32 32s-14.3 32-32 32H320c-17.7 0-32-14.3-32-32s14.3-32 32-32zm0 128H480c17.7 0 32 14.3 32 32s-14.3 32-32 32H320c-17.7 0-32-14.3-32-32s14.3-32 32-32zm0 128H544c17.7 0 32 14.3 32 32s-14.3 32-32 32H320c-17.7 0-32-14.3-32-32s14.3-32 32-32z"/></svg>'}),R=new M.LabIcon({name:"jupyterlab-notechat:help-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">\x3c!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2023 Fonticons, Inc.--\x3e<path class="notechat-color" d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM169.8 165.3c7.9-22.3 29.1-37.3 52.8-37.3h58.3c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24V250.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1H222.6c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"/></svg>'}),B=new M.LabIcon({name:"jupyterlab-notechat:user-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="16" width="20" viewBox="0 0 640 512">\x3c!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2023 Fonticons, Inc.--\x3e<path class="notechat-color" d="M96 128a128 128 0 1 1 256 0A128 128 0 1 1 96 128zM0 482.3C0 383.8 79.8 304 178.3 304h91.4C368.2 304 448 383.8 448 482.3c0 16.4-13.3 29.7-29.7 29.7H29.7C13.3 512 0 498.7 0 482.3zM504 312V248H440c-13.3 0-24-10.7-24-24s10.7-24 24-24h64V136c0-13.3 10.7-24 24-24s24 10.7 24 24v64h64c13.3 0 24 10.7 24 24s-10.7 24-24 24H552v64c0 13.3-10.7 24-24 24s-24-10.7-24-24z"/></svg>'}),F=new Map,H={id:r.plugin_id,description:"Chat with an AI Assistant in the Notebook using LLM API",autoStart:!0,requires:[a.ICommandPalette,i.INotebookTracker,n.ISettingRegistry],activate:(e,t,o,n)=>{console.log("JupyterLab extension jupyterlab-notechat is activated!"),n&&n.load(H.id).then(n=>{console.log("NoteChat: settings loaded",n.composite),function(e,t,o){const n="jupyterlab-notechat:chat-cell-data";e.commands.addCommand(n,{label:"Chat with AI Assistant",icon:$,execute:()=>{const e=o.currentWidget;if(!e)return;const t=F.get(e);return t&&t.chatCellData?(console.log("NoteChat: command triggered chatButton id: ",t.creationTimestamp),t.chatCellData()):void 0}}),t.addItem({command:n,category:"notechat"}),e.commands.addKeyBinding({command:n,keys:["Alt C"],selector:".jp-Notebook"})}(e,t,o),o.widgetAdded.connect((e,t)=>{!function(e,t){let o=F.get(e);if(o)return void console.log("NoteChat: chatButton already on toolbar, id: ",o.creationTimestamp);o=new E(e,t,{label:"NoteChat",icon:$,iconClass:"show-cell-ref",tooltip:"Chat with AI Assistant"});e.toolbar.insertItem(11,"chatButton",o),F.set(e,o),e.disposed.connect(()=>{F.delete(e),console.log("NoteChat: panel and chatButton binding BUTTON_MAP size: ",F.size)})}(t,n),t.sessionContext.ready.then(()=>{console.log(`NoteChat: frontend refresh, session ready, initialize panel, panel id: ${t.id}`),U(t)}),t.sessionContext.statusChanged.connect((e,o)=>{"restarting"===o&&(console.log(`NoteChat: kernel ${o}, re-initialize panel, panel id: ${t.id}`),U(t))})}),function(e,t,o,n){const a="jupyterlab-notechat:chat-cell-data-all";e.commands.addCommand(a,{label:"Run All Cells with AI Assistant",icon:z,execute:()=>{const e=o.currentWidget;if(e)return V(e,n,null,null,null)}}),t.addItem({command:a,category:"notechat"}),e.commands.addKeyBinding({command:a,keys:["Alt R","Alt T"],selector:".jp-Notebook"})}(e,t,o,n),function(e,t,o,n){const a="jupyterlab-notechat:chat-cell-data-above";e.commands.addCommand(a,{label:"Run Above Cells with AI Assistant",icon:j,execute:()=>{const e=o.currentWidget;if(!e)return;const t=e.content.activeCellIndex;return V(e,n,null,t,null)}}),t.addItem({command:a,category:"notechat"}),e.commands.addKeyBinding({command:a,keys:["Alt R","Alt B"],selector:".jp-Notebook"})}(e,t,o,n),function(e,t,o,n){const a="jupyterlab-notechat:chat-cell-data-below";e.commands.addCommand(a,{label:"Run Below Cells with AI Assistant",icon:T,execute:()=>{const e=o.currentWidget;if(!e)return;const t=e.content.activeCellIndex;return V(e,n,t,null,null)}}),t.addItem({command:a,category:"notechat"}),e.commands.addKeyBinding({command:a,keys:["Alt R","Alt F"],selector:".jp-Notebook"})}(e,t,o,n),function(e,t,o,n){const a="jupyterlab-notechat:chat-cell-data-selected";e.commands.addCommand(a,{label:"Run Selected Cells with AI Assistant",icon:O,execute:()=>{const e=o.currentWidget;if(!e)return;const t=[];for(let o=0;o<e.content.widgets.length;o++){const n=e.content.widgets[o];e.content.isSelectedOrActive(n)&&t.push(o)}return console.log("NoteChat: selected cells index: ",t),0!==t.length?V(e,n,null,null,t):void 0}}),t.addItem({command:a,category:"notechat"}),e.commands.addKeyBinding({command:a,keys:["Alt R","Alt S"],selector:".jp-Notebook"})}(e,t,o,n),function(e,t,o,n){const a="jupyterlab-notechat:show-cell-ref";e.commands.addCommand(a,{label:"Show & Copy Cell ID for Ref",icon:S,iconClass:"show-cell-ref",execute:()=>{const e=o.currentWidget;if(e)return G(e,n)}}),t.addItem({command:a,category:"notechat"}),e.commands.addKeyBinding({command:a,keys:["Alt Q"],selector:".jp-Notebook"})}(e,t,o,n),function(e,t,o,n){const a="jupyterlab-notechat:help";e.commands.addCommand(a,{label:"Help: How to Use NoteChat",icon:R,execute:async()=>{const e=o.currentWidget;if(!e)return;const t=_+await K(e,n);k(t,e,2e3)}}),t.addItem({command:a,category:"notechat"}),e.commands.addKeyBinding({command:a,keys:["Alt H"],selector:".jp-Notebook"})}(e,t,o,n),function(e,t,o){const n="jupyterlab-notechat:add-user-cell";e.commands.addCommand(n,{label:"Add a User Chat Cell Below",icon:B,execute:()=>{const e=o.currentWidget;e&&W(e,"",`${r.user_name}\n\n`,!1,!1)}}),t.addItem({command:n,category:"notechat"}),e.commands.addKeyBinding({command:n,keys:["Alt U"],selector:".jp-Notebook"})}(e,t,o),i.NotebookActions.executed.connect((e,t)=>{!async function(e,t,o){var n,a,s,i,l;const{notebook:c,cell:d}=o;console.log("NoteChat: executed cell & id: ",null===(n=d.model.toJSON().source)||void 0===n?void 0:n.toString(),"\nid: ",d.model.toJSON().id);const m=e.find(e=>e.content===c),h=[];if(m){const e=null!==(s=null===(a=d.model.toJSON().source)||void 0===a?void 0:a.toString())&&void 0!==s?s:"",t=await L(e,[r.ai_name,r.user_name],[`${r.ref_name} || ${r.ref_name}s`]),o=I(t);h.push(`${r.ref_name}s["${d.model.toJSON().id}"] = base64.b64decode("${o}").decode('utf-8')`),h.push(`${r.ref_name} = base64.b64decode("${o}").decode('utf-8')`),null===(l=null===(i=m.sessionContext.session)||void 0===i?void 0:i.kernel)||void 0===l||l.requestExecute({code:h.join("\n")})}}(o,0,t)})}).catch(e=>{console.error("NoteChat: failed to load settings for jupyterlab-notechat.",e)})}};class E extends a.ToolbarButton{constructor(e,t,...o){super(...o),this.handleClick=()=>{console.log("NoteChat: chatButton ON CLICK, id: ",this.creationTimestamp),this.chatCellData()},this.chatCellData=async()=>{var e,t;(null===(t=null===(e=this.panel)||void 0===e?void 0:e.model)||void 0===t?void 0:t.getMetadata("is_chatting"))?k("Please wait a moment, the AI Assistant is responding...",this.panel,2e3):(this.startRotation(),await D(this.panel,this.settings),this.stopRotation())},this.creationTimestamp=Date.now(),this.panel=e,this.settings=t,this.node.addEventListener("click",this.handleClick)}startRotation(){const e=this.node.querySelector('[data-icon="jupyterlab-notechat:atom-icon"]');e&&e.classList.add("rotate","rotate-color")}stopRotation(){const e=this.node.querySelector('[data-icon="jupyterlab-notechat:atom-icon"]');e&&e.classList.remove("rotate","rotate-color")}}const D=async(e,t)=>{var o,n,a,s,i,l,d,m,h,u,p,g,f,b,v,w,y,x;if(!e||!t)return;null===(o=null==e?void 0:e.model)||void 0===o||o.setMetadata("is_chatting",!0),console.log("NoteChat: START chatting, notebook is_chatting status: ",null===(n=null==e?void 0:e.model)||void 0===n?void 0:n.getMetadata("is_chatting"));const C={...r,...c},_=null!==(a=t.get("num_prev_cells").composite)&&void 0!==a?a:r.num_prev_cells;C.num_prev_cells=_,C.prompt=null!==(s=t.get("prompt").composite)&&void 0!==s?s:c.prompt,C.model=t.get("model").composite||c.model,C.vision_model=t.get("vision_model").composite||c.vision_model,C.use_vision=null!==(i=t.get("use_vision").composite)&&void 0!==i?i:c.use_vision,C.max_input=t.get("max_input").composite||c.max_input,C.max_output=t.get("max_output").composite||c.max_output,C.temperature=null!==(l=t.get("temperature").composite)&&void 0!==l?l:c.temperature,C.llm_api_key=t.get("llm_api_key").composite||c.llm_api_key;const k=null!==(m=null===(d=null==e?void 0:e.model)||void 0===d?void 0:d.getMetadata("notechat"))&&void 0!==m?m:{};let I=e.content.activeCellIndex;const L=e.content.widgets.length-1;let M=null!==(p=null===(u=null===(h=e.content.activeCell)||void 0===h?void 0:h.model.toJSON().source)||void 0===u?void 0:u.toString().trim().split("\n")[0])&&void 0!==p?p:"",$="",S="";for(;M.startsWith(r.ai_name);)$=M.trim(),I-=1,console.log("NoteChat: this is an AI Assistant reply, jump to previous cell for question, previous id : ",I),e.content.activeCellIndex=I,M=null!==(b=null===(f=null===(g=e.content.activeCell)||void 0===g?void 0:g.model.toJSON().source)||void 0===f?void 0:f.toString().trim().split("\n")[0])&&void 0!==b?b:"";S=M.trim();const z=await A($),j=await A(S),T={...C,...k,...z,...j};T.active_cell_index=I;const O=await N(T[r.cell_param_name_refs],I,L,T.num_prev_cells),R=await J(e,O),B=await q(R,T);e.content.activeCellIndex=I,(null===(w=null===(v=e.content.widgets[I+1])||void 0===v?void 0:v.model.toJSON().source)||void 0===w?void 0:w.toString().startsWith(r.ai_name))?(console.log(`NoteChat: replace below md cell content containing ${r.ai_name}`),$?await P(e,B,`${$}\n\n`,!0,!0):await P(e,B,`${r.ai_name}\n\n`,!0,!0)):await W(e,B,`${r.ai_name}\n\n`,!0,!0),null===(y=null==e?void 0:e.model)||void 0===y||y.setMetadata("is_chatting",!1),console.log("NoteChat: END chatting, notebook is_chatting status: ",null===(x=null==e?void 0:e.model)||void 0===x?void 0:x.getMetadata("is_chatting"))},J=async(e,t=null)=>{var o;if(!e)return[];const n=[];for(let a=0;a<e.content.widgets.length;a++){const s=null===(o=e.content.widgets[a])||void 0===o?void 0:o.model.toJSON();if(!t||t.includes(a)||t.includes(s.id)){if(s.num_id=a,Array.isArray(s.outputs))for(const e of s.outputs){const t=e;if(t.data){const e=Object.keys(t.data);for(const o of e)r.data_types.includes(o)||delete t.data[o]}}n.push(s)}}return n},q=async(e,t)=>{if(!e)return"No context is provided to the assistant...";try{const o={cell_json_arr:e,...t},n=l.ServerConnection.makeSettings({}),a=await l.ServerConnection.makeRequest(s.URLExt.join(n.baseUrl,"/jupyterlab-notechat/chat"),{method:"POST",body:JSON.stringify(o),headers:{"Content-Type":"application/json"}},n);if(!a.ok)return console.error("NoteChat: ERROR in sending data to the server: ",a.statusText),"Error in sending data to the server...";const i=await a.json();console.log("NoteChat: get server response:",i);try{return i.choices[0].message.content}catch(e){return JSON.stringify(i)}}catch(e){return console.error("NoteChat: ERROR in function getChatCompletions: ",e),"Error in function getChatCompletions..."}},W=async(e,t,o="",n=!0,a=!0)=>{i.NotebookActions.insertBelow(e.content);const s=e.content.activeCell;if(s){"markdown"!==s.model.type&&i.NotebookActions.changeCellType(e.content,"markdown");const l=e.content.activeCell,c=n?`\n\n<div style="text-align: right; color: lightgray; font-style: italic; font-size: x-small;">${r.ref_name} || ${r.ref_name}s["${null==l?void 0:l.model.toJSON().id}"]</div>`:"";l.model.sharedModel.setSource(o+t+c),a&&await i.NotebookActions.run(e.content,e.sessionContext)}},P=async(e,t,o="",n=!0,a=!0)=>{i.NotebookActions.selectBelow(e.content);const s=e.content.activeCell;if(s){"markdown"!==s.model.type&&i.NotebookActions.changeCellType(e.content,"markdown");const l=e.content.activeCell,c=n?`\n\n<div style="text-align: right; color: lightgray; font-style: italic; font-size: x-small;">${r.ref_name} || ${r.ref_name}s["${null==l?void 0:l.model.toJSON().id}"]</div>`:"";l.model.sharedModel.setSource(o+t+c),a&&await i.NotebookActions.run(e.content,e.sessionContext)}},V=async(e,t,o,n,a=null)=>{var s,l,c,d,m,h,u,p,g;if(!e||!t)return;k("Start running cells with AI Assistant, please do not add or delete any cells during running...",e,2e3),console.log("NoteChat: START run cells with chatting");const f=e.content.widgets.length-1;o=null!=o?o:0,(null!==(c=null===(l=null===(s=e.content.widgets[o])||void 0===s?void 0:s.model.toJSON().source)||void 0===l?void 0:l.toString())&&void 0!==c?c:"").startsWith(r.ai_name)&&(o=Math.max(o-1,0));const b=[];for(let t=n=null!=n?n:f;t>=o;t--){if(a&&!a.includes(t))continue;const o=null!==(h=null===(m=null===(d=e.content.widgets[t])||void 0===d?void 0:d.model.toJSON().source)||void 0===m?void 0:m.toString())&&void 0!==h?h:"";if(!o.startsWith(r.ai_name)){const n=null!==(g=null===(p=null===(u=e.content.widgets[t+1])||void 0===u?void 0:u.model.toJSON().source)||void 0===p?void 0:p.toString())&&void 0!==g?g:"";o.startsWith(r.user_name)||n.startsWith(r.ai_name)?b.push({id:t,type:"chat"}):b.push({id:t,type:"normal"})}}b.reverse(),console.log("NoteChat: run all cells, id: ",b);const v=F.get(e);console.log("NoteChat: run all cells triggered chatButton id: ",v.creationTimestamp);for(const t of b)"chat"===t.type?(console.log("NoteChat: run cell with chatting, id: ",t.id),e.content.activeCellIndex=t.id,await i.NotebookActions.run(e.content,e.sessionContext),await v.chatCellData()):(console.log("NoteChat: run cell normally, id: ",t.id),e.content.activeCellIndex=t.id,await i.NotebookActions.run(e.content,e.sessionContext));console.log("NoteChat: End run cells with chatting")},U=async e=>{var t,o,n,a,s,i;if((null===(t=null==e?void 0:e.model)||void 0===t?void 0:t.getMetadata("is_chatting"))&&(null===(o=null==e?void 0:e.model)||void 0===o||o.setMetadata("is_chatting",!1)),!e||0===e.content.widgets.length)return;const l=["import base64",`${r.ref_name}s = {}`];let c="";for(let t=0;t<e.content.widgets.length;t++){const o=e.content.widgets[t],s=null!==(a=null===(n=o.model.toJSON().source)||void 0===n?void 0:n.toString())&&void 0!==a?a:"",i=await L(s,[r.ai_name,r.user_name],[`${r.ref_name} || ${r.ref_name}s`]),d=I(i);l.push(`${r.ref_name}s["${o.model.toJSON().id}"] = base64.b64decode("${d}").decode('utf-8')`),c=`${r.ref_name} = base64.b64decode("${d}").decode('utf-8')`}c&&l.push(c),null===(i=null===(s=e.sessionContext.session)||void 0===s?void 0:s.kernel)||void 0===i||i.requestExecute({code:l.join("\n")})},K=async(e,t)=>{var o,n,a,s,i,l;if(!e||!t)return"";const d={...r,...c},m=t.get("num_prev_cells").composite||r.num_prev_cells;d.num_prev_cells=m;let h="--------<br>Params Parsed ：";const u=(null!==(a=null===(n=null===(o=e.content.activeCell)||void 0===o?void 0:o.model.toJSON().source)||void 0===n?void 0:n.toString())&&void 0!==a?a:"").trim().split("\n"),p=await A(null!==(s=u[0])&&void 0!==s?s:""),g=null!==(l=null===(i=null==e?void 0:e.model)||void 0===i?void 0:i.getMetadata("notechat"))&&void 0!==l?l:{},f={...d,...g,...p};let b=0,v="";for(const e in p)v+=`${e}: ${p[e]} || `,b++;h+=`total ${b} params：|| `,h=h+v+`<br>--------<br>Sequetial IDs Parsed: current ID ${e.content.activeCellIndex}，`;const w=await N(f[r.cell_param_name_refs],e.content.activeCellIndex,e.content.widgets.length-1,f.num_prev_cells);return h+=`total ${w.length} ids：|| `,h=h+w.join(", ")+" ||",h},G=async(e,t)=>{var o;if(!e||!t)return;const n=null===(o=e.content.activeCell)||void 0===o?void 0:o.model.toJSON().id,a=e.content.activeCellIndex,s=`Copied to Clipboard: Unique ID: ${n} || Sequetial ID: ${a} <br>`+await K(e,t);k(s,e,2e3),navigator.clipboard&&navigator.clipboard.writeText(`_ref || _refs["${n}"] || ${a}`)},Y=H}}]);