{% extends "base.html" %}

{% block title %}{{ patient.full_name }} - Patient Details{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Patient Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h1 class="h3 mb-1">
                                <i class="fas fa-user-circle me-2 text-primary"></i>
                                {{ patient.full_name }}
                            </h1>
                            <p class="text-muted mb-0">
                                MRN: <strong>{{ patient.medical_record_number }}</strong>
                            </p>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-success me-2" onclick="orderLabTest('{{ patient.id }}')">
                                <i class="fas fa-flask me-2"></i>Order Lab Test
                            </button>
                            <a href="{{ url_for('patients') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Patients
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Patient Information -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Patient Information
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Full Name:</dt>
                        <dd class="col-sm-8">{{ patient.full_name }}</dd>
                        
                        <dt class="col-sm-4">Date of Birth:</dt>
                        <dd class="col-sm-8">{{ patient.date_of_birth }}</dd>
                        
                        <dt class="col-sm-4">Gender:</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-{{ 'primary' if patient.gender == 'Male' else 'success' if patient.gender == 'Female' else 'secondary' }}">
                                {{ patient.gender }}
                            </span>
                        </dd>
                        
                        <dt class="col-sm-4">Phone:</dt>
                        <dd class="col-sm-8">{{ patient.phone or 'Not provided' }}</dd>
                        
                        <dt class="col-sm-4">Email:</dt>
                        <dd class="col-sm-8">{{ patient.email or 'Not provided' }}</dd>
                        
                        <dt class="col-sm-4">Address:</dt>
                        <dd class="col-sm-8">{{ patient.address or 'Not provided' }}</dd>
                        
                        <dt class="col-sm-4">Created:</dt>
                        <dd class="col-sm-8">{{ patient.created_at[:19] }}</dd>
                    </dl>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card shadow h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>Quick Stats
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h3 class="text-primary">{{ lab_results|length }}</h3>
                                <p class="text-muted mb-0">Total Lab Results</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <h3 class="text-warning">{{ lab_results|selectattr('status', 'equalto', 'pending')|list|length }}</h3>
                            <p class="text-muted mb-0">Pending Results</p>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h3 class="text-success">{{ lab_results|selectattr('status', 'equalto', 'completed')|list|length }}</h3>
                                <p class="text-muted mb-0">Completed Tests</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <h3 class="text-info">{{ (lab_results|groupby('test_type'))|list|length }}</h3>
                            <p class="text-muted mb-0">Test Categories</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lab Results -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-flask me-2"></i>Lab Results
                    </h5>
                </div>
                <div class="card-body">
                    {% if lab_results %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Test Name</th>
                                        <th>Type</th>
                                        <th>Result</th>
                                        <th>Reference Range</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for result in lab_results %}
                                    <tr>
                                        <td><strong>{{ result.test_name }}</strong></td>
                                        <td>
                                            <span class="badge bg-secondary">{{ result.test_type }}</span>
                                        </td>
                                        <td>
                                            {% if result.status == 'completed' %}
                                                <strong class="text-primary">{{ result.result_value }}</strong>
                                            {% else %}
                                                <em class="text-muted">{{ result.result_value }}</em>
                                            {% endif %}
                                        </td>
                                        <td><small class="text-muted">{{ result.reference_range }}</small></td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if result.status == 'completed' else 'warning' if result.status == 'pending' else 'danger' }}">
                                                {{ result.status.title() }}
                                            </span>
                                        </td>
                                        <td><small>{{ result.result_date[:19] }}</small></td>
                                        <td><small>{{ result.notes or '-' }}</small></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-flask fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No lab results found</h5>
                            <p class="text-muted">Start by ordering a lab test for this patient.</p>
                            <button type="button" class="btn btn-primary" onclick="orderLabTest('{{ patient.id }}')">
                                <i class="fas fa-plus me-2"></i>Order First Lab Test
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lab Order Modal -->
<div class="modal fade" id="labOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-flask me-2"></i>Order Lab Test for {{ patient.full_name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <form id="labOrderForm" method="POST" action="{{ url_for('order_lab_tests', patient_id=patient.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="test_name" class="form-label">Test Name</label>
                        <select class="form-select" id="test_name" name="test_name" required>
                            <option value="Complete Blood Count">Complete Blood Count (CBC)</option>
                            <option value="Basic Metabolic Panel">Basic Metabolic Panel (BMP)</option>
                            <option value="Lipid Panel">Lipid Panel</option>
                            <option value="Thyroid Function">Thyroid Function Tests</option>
                            <option value="Liver Function">Liver Function Tests</option>
                            <option value="Hemoglobin A1c">Hemoglobin A1c</option>
                            <option value="Urinalysis">Urinalysis</option>
                            <option value="Vitamin D">Vitamin D</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="test_type" class="form-label">Test Type</label>
                        <select class="form-select" id="test_type" name="test_type" required>
                            <option value="Hematology">Hematology</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Endocrinology">Endocrinology</option>
                            <option value="Microbiology">Microbiology</option>
                            <option value="Immunology">Immunology</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reference_range" class="form-label">Reference Range</label>
                        <input type="text" class="form-control" id="reference_range" name="reference_range" value="Normal ranges apply">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-paper-plane me-2"></i>Order Test
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function orderLabTest(patientId) {
    const modal = new bootstrap.Modal(document.getElementById('labOrderModal'));
    modal.show();
}
</script>
{% endblock %}
