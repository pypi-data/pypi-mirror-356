import copy
import pytest
import pandas as pd
import numpy as np
from standard_evaluator import FloatVariable, IntVariable, ArrayVariable
from standard_evaluator import EvaluatorInfo, GroupInfo, JoinedInfo,OptProblem, MAXINT

def test_evaluator_info():
    with pytest.raises(ValueError):
        # Check that if if you try to name two inputs the same it throws an error
        EvaluatorInfo(name="bla", inputs=[{"name": "x0"}, {"name": "x0"}])

    with pytest.raises(ValueError):
        # Check that if if you try to name two outputs the same it throws an error
        EvaluatorInfo(name="bla", outputs=[{"name": "x0"}, {"name": "x0"}])
    my_eval = EvaluatorInfo(
        name="dummy",
        inputs=[
            ArrayVariable(name="x1", default=[[299.3, 243.5]]),
            FloatVariable(name="p2", class_type="float"),
        ],
        outputs=[FloatVariable(name="y2", class_type="float")],
    )
    expected = {
        "name": "dummy",
        "class_type": "EvaluatorInfo",
        "inputs": [
            {
                "name": "x1",
                "default": np.array([[299.3, 243.5]]),
                "bounds": None,
                "shift": None,
                "scale": None,
                "units": None,
                "description": "",
                "class_type": "floatarray",
                "shape": (1, 2),
                "options": {},
            },
            {
                "name": "p2",
                "default": None,
                "bounds": (-np.inf, np.inf),
                "shift": 0.0,
                "scale": 1.0,
                "units": None,
                "description": "",
                "class_type": "float",
                "options": {},
            },
        ],
        "outputs": [
            {
                "name": "y2",
                "default": None,
                "bounds": (-np.inf, np.inf),
                "shift": 0.0,
                "scale": 1.0,
                "units": None,
                "description": "",
                "class_type": "float",
                "options": {},
            }
        ],
        "description": None,
        "cite": None,
        "tool": None,
        "evaluator_identifier": None,
        "version": None,
        "component_type": None,
        "options": {},
    }
    np.testing.assert_equal(expected, my_eval.model_dump())

def test_group():
    x1 = ArrayVariable(name="x1", default=[[299.3, 243.5]])
    p2 = FloatVariable(name="p2")
    q1 = FloatVariable(name="q1")
    y2 = FloatVariable(name="y2")
    y4 = FloatVariable(name="y4")
    my_eval1 = EvaluatorInfo(
            name="Part1",
            inputs=[x1, p2, q1],
            outputs=[y2],
        )
    my_eval2 = EvaluatorInfo(
            name="Part2",
            inputs=[x1, p2, y2],
            outputs=[y4],
        )
    my_group = GroupInfo(name="MyGroup",
            inputs=[x1, p2, q1],
            outputs=[y4],
            components={my_eval1.name: my_eval1, my_eval2.name: my_eval2},
            component_order=[my_eval1.name, my_eval2.name],
            linkage=[("Part1.x1", "x1"), ("Part1.p2", "p2"), ("Part1.q1", "q1"),
                    ("Part1.y2", "Part2.y2"), ("Part2.x1", "x1"), ("Part2.p2", "p2"),
                    ("Part2.y4", "y4")])
    expected = {'name': 'MyGroup',
 'class_type': 'GroupInfo',
 'inputs': [{'name': 'x1',
   'default': np.array([[299.3, 243.5]]),
   'bounds': None,
   'shift': None,
   'scale': None,
   'units': None,
   'description': '',
   'options': {},
   'class_type': 'floatarray',
   'shape': (1, 2)},
  {'name': 'p2',
   'default': None,
   'bounds': (-np.inf, np.inf),
   'shift': 0.0,
   'scale': 1.0,
   'units': None,
   'description': '',
   'options': {},
   'class_type': 'float'},
  {'name': 'q1',
   'default': None,
   'bounds': (-np.inf, np.inf),
   'shift': 0.0,
   'scale': 1.0,
   'units': None,
   'description': '',
   'options': {},
   'class_type': 'float'}],
 'outputs': [{'name': 'y4',
   'default': None,
   'bounds': (-np.inf, np.inf),
   'shift': 0.0,
   'scale': 1.0,
   'units': None,
   'description': '',
   'options': {},
   'class_type': 'float'}],
 'description': None,
 'cite': None,
 'tool': None,
 'evaluator_identifier': None,
 'version': None,
 'component_type': None,
 'options': {},
 'component_order': ['Part1', 'Part2'],
 'components': {'Part1': {'name': 'Part1',
   'class_type': 'EvaluatorInfo',
   'inputs': [{'name': 'x1',
     'default': np.array([[299.3, 243.5]]),
     'bounds': None,
     'shift': None,
     'scale': None,
     'units': None,
     'description': '',
     'options': {},
     'class_type': 'floatarray',
     'shape': (1, 2)},
    {'name': 'p2',
     'default': None,
     'bounds': (-np.inf, np.inf),
     'shift': 0.0,
     'scale': 1.0,
     'units': None,
     'description': '',
     'options': {},
     'class_type': 'float'},
    {'name': 'q1',
     'default': None,
     'bounds': (-np.inf, np.inf),
     'shift': 0.0,
     'scale': 1.0,
     'units': None,
     'description': '',
     'options': {},
     'class_type': 'float'}],
   'outputs': [{'name': 'y2',
     'default': None,
     'bounds': (-np.inf, np.inf),
     'shift': 0.0,
     'scale': 1.0,
     'units': None,
     'description': '',
     'options': {},
     'class_type': 'float'}],
   'description': None,
   'cite': None,
   'tool': None,
   'evaluator_identifier': None,
   'version': None,
   'component_type': None,
   'options': {}},
  'Part2': {'name': 'Part2',
   'class_type': 'EvaluatorInfo',
   'inputs': [{'name': 'x1',
     'default': np.array([[299.3, 243.5]]),
     'bounds': None,
     'shift': None,
     'scale': None,
     'units': None,
     'description': '',
     'options': {},
     'class_type': 'floatarray',
     'shape': (1, 2)},
    {'name': 'p2',
     'default': None,
     'bounds': (-np.inf, np.inf),
     'shift': 0.0,
     'scale': 1.0,
     'units': None,
     'description': '',
     'options': {},
     'class_type': 'float'},
    {'name': 'y2',
     'default': None,
     'bounds': (-np.inf, np.inf),
     'shift': 0.0,
     'scale': 1.0,
     'units': None,
     'description': '',
     'options': {},
     'class_type': 'float'}],
   'outputs': [{'name': 'y4',
     'default': None,
     'bounds': (-np.inf, np.inf),
     'shift': 0.0,
     'scale': 1.0,
     'units': None,
     'description': '',
     'options': {},
     'class_type': 'float'}],
   'description': None,
   'cite': None,
   'tool': None,
   'evaluator_identifier': None,
   'version': None,
   'component_type': None,
   'options': {}}},
 'linkage': [('Part1.x1', 'x1'),
  ('Part1.p2', 'p2'),
  ('Part1.q1', 'q1'),
  ('Part1.y2', 'Part2.y2'),
  ('Part2.x1', 'x1'),
  ('Part2.p2', 'p2'),
  ('Part2.y4', 'y4')],
  'promotions': {},
  }
    np.testing.assert_equal(expected, my_group.model_dump())